<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tema | Floresce Terapias</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Montserrat:wght@300;400;500&display=swap"
        rel="stylesheet">

    <!-- Access Control & Firebase -->
    <script src="access-control.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="init-firebase.js"></script>

    <style>
        .theme-header {
            background: var(--bg-color-alt);
            padding: 80px 20px 40px;
            text-align: center;
        }

        .meditation-list {
            max-width: 800px;
            margin: 40px auto;
            display: grid;
            gap: 20px;
        }

        .meditation-item {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: 0.2s;
        }

        .med-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .med-icon-wrapper {
            width: 40px;
            height: 40px;
            background: var(--color-primary);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .med-info h3 {
            margin-bottom: 5px;
            font-size: 1.2rem;
            color: var(--color-text-main);
        }

        .med-info p {
            font-size: 0.95rem;
            color: #666;
            line-height: 1.5;
        }

        /* Players */
        .med-player-container {
            width: 100%;
            margin-top: 10px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
        }

        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            /* 16:9 */
            height: 0;
        }

        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 4px;
        }

        audio {
            width: 100%;
            outline: none;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container nav-content">
            <div class="brand-container">
                <a href="dashboard.html" class="logo">Floresce Terapias</a>
            </div>
            <ul class="nav-links">
                <li><a href="dashboard.html">Voltar à Área de Membros</a></li>
            </ul>
        </div>
    </nav>

    <header class="theme-header">
        <h1 class="section-title" id="theme-title">A carregar...</h1>
        <p>Recursos exclusivos para a tua jornada.</p>
    </header>

    <main class="container">
        <div class="meditation-list" id="dynamic-meditations">
            <p style="text-align: center;">A carregar recursos...</p>
        </div>
    </main>

    <script>
        lucide.createIcons();

        // Theme Names Mapping
        const themeNames = {
            'enraizamento': 'Enraizamento',
            'limpeza': 'Limpeza Energética',
            'protecao': 'Proteção',
            'intuicao': 'Intuição',
            'chakras': 'Equilíbrio dos Chakras'
        };

        async function loadThemeContent() {
            const params = new URLSearchParams(window.location.search);
            const themeId = params.get('id');

            if (!themeId) {
                window.location.href = 'dashboard.html';
                return;
            }

            // Set Title
            const displayTitle = themeNames[themeId] || 'Tema Específico';
            document.getElementById('theme-title').textContent = displayTitle;
            document.title = `${displayTitle} | Floresce Terapias`;

            // Wait for DB
            const checkDb = () => {
                if (window.db) {
                    fetchMeditations(themeId);
                } else {
                    setTimeout(checkDb, 100);
                }
            };
            checkDb();
        }

        async function fetchMeditations(themeId) {
            const container = document.getElementById('dynamic-meditations');
            try {
                const snapshot = await window.db.collection('meditations')
                    .where('theme', '==', themeId)
                    .get();

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: whitesmoke; border-radius: 8px;">
                            <i data-lucide="cloud-off" style="margin-bottom: 15px; color: #999;"></i>
                            <p>Ainda não existem recursos disponíveis para este tema.</p>
                            <a href="dashboard.html" class="btn btn-primary" style="margin-top:20px; display:inline-block;">Voltar</a>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let playerHtml = '';

                    // Auto-detect Video URL
                    if (data.url && (data.url.includes('youtube.com') || data.url.includes('youtu.be') || data.url.includes('vimeo'))) {
                        data.type = 'video';
                    }

                    // Video Logic
                    if (data.type === 'video') {
                        // Handle Youtube/Vimeo embeds
                        // Handle Youtube/Vimeo embeds
                        let embedUrl = data.url;
                        if (embedUrl.includes('youtube.com/watch?v=')) {
                            const videoId = embedUrl.split('v=')[1].split('&')[0];
                            embedUrl = `https://www.youtube-nocookie.com/embed/${videoId}`;
                        } else if (embedUrl.includes('youtu.be/')) {
                            const videoId = embedUrl.split('youtu.be/')[1];
                            embedUrl = `https://www.youtube-nocookie.com/embed/${videoId}`;
                        }
                        // If it's already an embed link, ensure it uses nocookie if possible for consistency, 
                        // but primarily just trust the user's input if they pasted a full iframe.
                        else if (embedUrl.includes('youtube.com/embed/')) {
                            embedUrl = embedUrl.replace('youtube.com', 'youtube-nocookie.com');
                        }

                        playerHtml = `
                        <div class="med-player-container">
                            <div class="video-wrapper">
                                <iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                            </div>
                        </div>`;
                    }
                    // Audio Logic
                    else {
                        playerHtml = `
                        <div class="med-player-container">
                            <audio controls>
                                <source src="${data.url}" type="audio/mpeg">
                                O teu navegador não suporta o elemento de áudio.
                            </audio>
                        </div>`;
                    }

                    const iconName = data.type === 'video' ? 'video' : 'music';

                    html += `
                    <div class="meditation-item">
                        <div class="med-header">
                            <div class="med-icon-wrapper"><i data-lucide="${iconName}"></i></div>
                            <div class="med-info">
                                <h3>${data.title}</h3>
                                ${data.description ? `<p>${data.description}</p>` : ''}
                            </div>
                        </div>
                        ${playerHtml}
                    </div>`;
                });

                container.innerHTML = html;
                lucide.createIcons();

            } catch (error) {
                console.error("Error loading meditations:", error);
                container.innerHTML = '<p style="text-align:center; color:red;">Erro ao carregar recursos.</p>';
            }
        }

        loadThemeContent();
    </script>
</body>

</html>