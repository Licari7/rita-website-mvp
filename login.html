<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Floresce Terapias</title>
    <script src="theme-loader.js"></script>
    <link rel="stylesheet" href="style.css?v=5.1.8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Montserrat:wght@300;400;500&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- EmailJS SDK (for pending-user admin notifications) -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>emailjs.init("gGZY_zuQOJdC0hcAH");</script>

    <style>
        .forgot-pwd-link {
            font-size: 14px !important;
            color: #e1d7ce !important;
            text-decoration: underline !important;
            display: block !important;
            margin-top: 10px;
            opacity: 1 !important;
            visibility: visible !important;
        }

        .forgot-pwd-link:hover {
            color: #ffffff !important;
        }

        #forgotPwdWrapper {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            margin-top: 8px;
            text-align: center;
        }
    </style>
</head>

<body class="auth-page">

    <div class="mobile-menu"></div>

    <div class="auth-container">
        <a href="index.html" class="back-link">&larr; Voltar</a>

        <div class="auth-card">
            <div class="text-center">
                <div class="logo-small">Floresce Terapias</div>
                <h2>√Årea Reservada</h2>
            </div>

            <div id="loginForm" class="auth-form">
                <div class="form-group hidden" id="nameGroup">
                    <label for="signupName">Nome</label>
                    <input type="text" id="signupName" placeholder="Como te podemos chamar?">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required placeholder="oteu@email.com">
                </div>
                <!-- ... existing password ... -->
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" required class="password-input">
                        <button type="button" id="togglePassword" class="password-toggle-btn"
                            aria-label="Mostrar password">
                            <i data-lucide="eye"></i>
                        </button>
                    </div>
                </div>
                <!-- Button type="button" to prevent form submission -->
                <button type="button" id="loginBtn" class="btn btn-primary full-width">Entrar</button>
            </div>

            <p class="auth-footer text-center" id="authFooter">
                Ainda n√£o √©s membro? <a href="#" id="toggleSignupBtn">Subscrever agora</a>
                <br><small class="auth-small-text">CREATED BY CALB</small>
            </p>
            <p id="forgotPwdWrapper">
                <a href="#" id="forgotPasswordBtn" class="forgot-pwd-link">Esqueci a password</a>
            </p>
        </div>
    </div>

    <script src="main.js"></script>
    <script src="sidebar.js"></script>

    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="init-firebase.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("LOGIN SCRIPT STARTED");
            lucide.createIcons();

            const loginBtn = document.getElementById('loginBtn');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');

            // --- REAL AUTH SYSTEM ONLY ---
            function ensureAuth() {
                if (window.auth) {
                    return Promise.resolve(window.auth);
                } else {
                    console.error("Firebase not loaded correctly.");
                    alert("Erro de conex√£o. Por favor recarregue a p√°gina.");
                    return Promise.reject("Firebase unavailable");
                }
            }

            // --- PASSWORD RESET ---
            const forgotBtn = document.getElementById('forgotPasswordBtn');
            if (forgotBtn) {
                forgotBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const emailVal = document.getElementById('email').value.trim();
                    if (!emailVal) {
                        alert('Introduz o teu email no campo acima e clica novamente em "Esqueci a password".');
                        return;
                    }
                    try {
                        const authInstance = await ensureAuth();
                        await authInstance.sendPasswordResetEmail(emailVal);
                        alert(`Email de recupera√ß√£o enviado para ${emailVal}.\n\nVerifica a caixa de entrada (e a pasta de spam).`);
                    } catch (err) {
                        if (err.code === 'auth/user-not-found') {
                            alert('N√£o existe nenhuma conta com esse email.');
                        } else {
                            alert('Erro ao enviar email: ' + err.message);
                        }
                    }
                });
            }

            // Initialize Auth Persistence
            if (window.auth) {
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(() => { });
            }

            // Toggle Signup/Login Mode (Delegated)
            const authFooter = document.getElementById('authFooter');
            const nameGroup = document.getElementById('nameGroup');
            const authTitle = document.querySelector('.auth-card h2');
            let isSignupMode = false;

            if (authFooter) {
                authFooter.addEventListener('click', (e) => {
                    if (e.target.id === 'toggleSignupBtn' || e.target.id === 'toggleLoginBtn') {
                        e.preventDefault();
                        isSignupMode = !isSignupMode;

                        if (isSignupMode) {
                            nameGroup.classList.remove('hidden');
                            nameGroup.style.display = 'block';
                            authTitle.textContent = 'Criar Conta';
                            loginBtn.textContent = 'Registar';
                            authFooter.innerHTML = 'J√° tens conta? <a href="#" id="toggleLoginBtn">Entrar</a>';
                            document.getElementById('forgotPwdWrapper').style.display = 'none';
                        } else {
                            nameGroup.classList.add('hidden');
                            nameGroup.style.display = 'none';
                            authTitle.textContent = '√Årea Reservada';
                            loginBtn.textContent = 'Entrar';
                            authFooter.innerHTML = 'Ainda n√£o √©s membro? <a href="#" id="toggleSignupBtn">Subscrever agora</a><br><small class="auth-small-text">CREATED BY CALB</small>';
                            document.getElementById('forgotPwdWrapper').style.display = 'block';
                        }
                    }
                });
            }

            // Login/Signup Action
            if (loginBtn) {
                loginBtn.addEventListener('click', async () => {
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    const name = document.getElementById('signupName').value;

                    if (!email || !password) {
                        alert("Por favor preencha email e password.");
                        return;
                    }

                    if (isSignupMode && !name) {
                        alert("Por favor diz-nos o teu nome.");
                        return;
                    }

                    const originalText = loginBtn.textContent;
                    loginBtn.textContent = "A processar...";
                    loginBtn.disabled = true;

                    // Ensure auth is ready
                    await ensureAuth();

                    try {
                        const db = window.db; // helper

                        if (isSignupMode) {
                            // --- INTELLIGENT REGISTRATION ---

                            // 1. Check if user already exists in DB (even if Auth is missing/messy)
                            let existingStatus = null;
                            if (db) {
                                const docCheck = await db.collection("users").doc(email).get();
                                if (docCheck.exists) {
                                    existingStatus = docCheck.data().status;
                                }
                            }

                            if (existingStatus === 'active') {
                                alert("J√° existe uma conta ativa com este email! Por favor faz Login.");
                                loginBtn.textContent = originalText;
                                loginBtn.disabled = false;
                                document.getElementById('toggleLoginBtn').click(); // Switch to login
                                return;
                            } else if (existingStatus === 'pending' || existingStatus === 'inactive') {
                                // User exists but needs to pay
                                if (confirm("J√° tens conta criada, mas a subscri√ß√£o n√£o est√° ativa. Queres reativar agora?")) {
                                    // TRIGGER STRIPE
                                    // Use 'startSubscription' from script.js, but we need to ensure we are logged in first? 
                                    // Actually, createCheckoutSession requires Auth.
                                    // So we must log them in.
                                    try {
                                        await window.auth.signInWithEmailAndPassword(email, password);
                                        await window.startSubscription('dashboard.html');
                                        return; // Redirecting...
                                    } catch (e) {
                                        alert("Por favor faz login com a tua password para reativar.");
                                        document.getElementById('toggleLoginBtn').click();
                                        return;
                                    }
                                }
                                loginBtn.textContent = originalText;
                                loginBtn.disabled = false;
                                return;
                            }

                            // 2. Create New User
                            let userCredential;
                            try {
                                userCredential = await window.auth.createUserWithEmailAndPassword(email, password);
                            } catch (err) {
                                if (err.code === 'auth/email-already-in-use') {
                                    alert("Este email j√° est√° registado. Tente fazer Login.");
                                    document.getElementById('toggleLoginBtn').click();
                                    loginBtn.textContent = originalText;
                                    loginBtn.disabled = false;
                                    return;
                                }
                                throw err;
                            }

                            const user = userCredential.user;

                            // 3. Save User to Firestore and Update Auth Profile
                            // Update Auth Profile (best-effort)
                            if (user.updateProfile) {
                                await user.updateProfile({ displayName: name }).catch(e => console.warn("updateProfile failed:", e));
                            }

                            // Determine status based on access mode
                            let newUserStatus = 'active'; // default: free access
                            if (db) {
                                try {
                                    const configDoc = await db.collection('config').doc('settings').get();
                                    if (configDoc.exists && configDoc.data().freeAccess === false) {
                                        newUserStatus = 'pending';
                                    }
                                } catch (configErr) {
                                    console.warn("Could not read access mode, defaulting to active:", configErr);
                                }
                            }

                            // Save to Firestore (best-effort ‚Äî auth already succeeded)
                            if (db) {
                                try {
                                    await db.collection("users").doc(email).set({
                                        uid: user.uid,
                                        name: name,
                                        email: email,
                                        status: newUserStatus,
                                        loginCount: 0,
                                        totalTimeSeconds: 0,
                                        incidents: [],
                                        createdAt: new Date(),
                                        lastLogin: new Date()
                                    });
                                } catch (dbError) {
                                    console.error("Firestore profile save failed (non-blocking):", dbError.code, dbError.message);
                                    // Don't block the user ‚Äî auth account was created successfully
                                }
                            }

                            // 4. AUTO-LOGIN SUCCESS
                            localStorage.setItem('userEmail', user.email);
                            localStorage.setItem('userName', name);
                            // Note: 'isMember' is only set for active users (see below)

                            if (newUserStatus === 'pending') {
                                // --- Notify Admin: Email ---
                                try {
                                    await emailjs.send('service_8726bv6', 'template_sboqw1k', {
                                        user_name: name,
                                        user_email: email,
                                        registration_date: new Date().toLocaleString('pt-PT'),
                                        name: name,
                                        email: email
                                    });
                                    console.log('Admin email notification sent.');
                                } catch (emailErr) {
                                    console.warn('Admin email notification failed:', emailErr);
                                }

                                alert("Conta criada com sucesso! ‚úÖ\n\nO seu acesso est√° PENDENTE de aprova√ß√£o pelo administrador. Receber√° confirma√ß√£o em breve.");
                                loginBtn.textContent = originalText;
                                loginBtn.disabled = false;
                                return;
                            } else {
                                // Active user: mark as member and redirect
                                localStorage.setItem('isMember', 'true');
                                alert("Conta criada com sucesso! Bem-vindo(a) √† fam√≠lia Floresce. üåø");
                                window.location.href = 'dashboard.html';
                            }

                        } else {
                            // --- LOGIN ---
                            const userCredential = await window.auth.signInWithEmailAndPassword(email, password);
                            const user = userCredential.user;

                            // 1. Check Status in Firestore
                            if (window.db) {
                                try {
                                    const docSnap = await window.db.collection("users").doc(user.email).get();
                                    if (docSnap.exists) {
                                        const userData = docSnap.data();

                                        // Blocked Check
                                        if (userData.status === 'blocked') {
                                            alert("Esta conta foi suspensa. Contacta a administra√ß√£o.");
                                            await window.auth.signOut();
                                            loginBtn.textContent = originalText;
                                            loginBtn.disabled = false;
                                            return;
                                        }

                                        // Pending Check (Acesso Restrito)
                                        if (userData.status === 'pending') {
                                            alert("‚è≥ O teu acesso ainda est√° pendente de aprova√ß√£o pelo administrador.\n\nReceber√°s confirma√ß√£o assim que for ativado.");
                                            await window.auth.signOut();
                                            loginBtn.textContent = originalText;
                                            loginBtn.disabled = false;
                                            return;
                                        }

                                        // Update last login and increment login counter
                                        window.db.collection("users").doc(user.email).update({
                                            lastLogin: new Date(),
                                            loginCount: window.firebase && window.firebase.firestore
                                                ? window.firebase.firestore.FieldValue.increment(1)
                                                : (docSnap.data().loginCount || 0) + 1
                                        }).catch(e => console.log("Erro a atualizar lastLogin", e));
                                    }
                                } catch (dbError) {
                                    console.log("DB Check skipped or failed", dbError);
                                }
                            }

                            // Success -> Redirect
                            // LocalStorage set in dashboard, but good to set here too
                            localStorage.setItem('userEmail', user.email);
                            localStorage.setItem('isMember', 'true');
                            window.location.href = 'dashboard.html';
                        }
                    } catch (error) {
                        console.error("Auth Failed:", error);
                        let msg = "Erro desconhecido: " + error.message;

                        if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                            msg = "Email ou Password inv√°lidos.";
                        } else if (error.code === 'auth/weak-password') {
                            msg = "A password deve ter pelo menos 6 caracteres.";
                        } else if (error.code === 'auth/email-already-in-use') {
                            msg = "Este email j√° est√° em uso.";
                        }

                        alert(msg);
                        loginBtn.textContent = originalText;
                        loginBtn.disabled = false;
                    }
                });
                console.error("Button not found");
            }

            // Password Toggle
            const togglePasswordBtn = document.getElementById('togglePassword');
            if (togglePasswordBtn) {
                togglePasswordBtn.addEventListener('click', (e) => {
                    // Prevent form submission if any
                    e.preventDefault();

                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);

                    // Update icon by replacing innerHTML
                    if (type === 'text') {
                        togglePasswordBtn.innerHTML = '<i data-lucide="eye-off"></i>';
                    } else {
                        togglePasswordBtn.innerHTML = '<i data-lucide="eye"></i>';
                    }
                    lucide.createIcons();
                });
            }

            // Allow Enter key
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') loginBtn.click();
                });
            }
        });
    </script>
</body>

</html>