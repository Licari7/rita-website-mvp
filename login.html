<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Floresce Terapias</title>
    <script src="theme-loader.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Montserrat:wght@300;400;500&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://js.stripe.com/v3/"></script>
</head>

<body class="auth-page">

    <div class="mobile-menu">
        <button class="close-menu" aria-label="Fechar Menu">
            <i data-lucide="x"></i>
        </button>
        <span class="mobile-logo">Floresce</span>

        <ul class="mobile-links-list">
            <li><a href="index.html">Início</a></li>
            <li><a href="index.html#about">Sobre</a></li>
            <li><a href="index.html#services">Serviços</a></li>
            <li><a href="index.html#events">Eventos</a></li>
            <li><a href="booking.html">Agenda</a></li>
            <li><a href="dashboard.html" style="color: var(--color-primary); font-weight: 600;">Área de Membros</a></li>
        </ul>

        <div class="mobile-socials">
            <a href="https://instagram.com/floresceterapias" target="_blank"><i data-lucide="instagram"></i></a>
            <a href="https://wa.me/351912345678" target="_blank"><i data-lucide="message-circle"></i></a>
        </div>
    </div>

    <div class="auth-container">
        <a href="index.html" class="back-link">&larr; Voltar ao site</a>

        <div class="auth-card">
            <div class="text-center">
                <div class="logo-small">Floresce Terapias</div>
                <h2>Área Reservada</h2>
            </div>

            <div id="loginForm" class="auth-form">
                <div class="form-group hidden" id="nameGroup" style="display: none;">
                    <label for="signupName">Nome</label>
                    <input type="text" id="signupName" placeholder="Como te podemos chamar?">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required placeholder="oteu@email.com">
                </div>
                <!-- ... existing password ... -->
                <div class="form-group">
                    <label for="password">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="password" required style="padding-right: 40px;">
                        <button type="button" id="togglePassword"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666;">
                            <i data-lucide="eye"></i>
                        </button>
                    </div>
                </div>
                <!-- Button type="button" to prevent form submission -->
                <button type="button" id="loginBtn" class="btn btn-primary full-width">Entrar</button>
            </div>

            <p class="auth-footer text-center" id="authFooter">
                Ainda não és membro? <a href="#" id="toggleSignupBtn">Subscrever agora</a>
                <br><small
                    style="font-size: 0.6rem; opacity: 0.5; display:block; margin-top:15px; letter-spacing: 1px;">CREATED
                    IN PORTUGAL WITH ❤️ BY CALB</small>
            </p>
        </div>
    </div>

    <script src="script.js"></script>

    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="init-firebase.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("LOGIN SCRIPT STARTED");
            lucide.createIcons();

            const loginBtn = document.getElementById('loginBtn');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');

            // --- REAL AUTH SYSTEM ONLY ---
            function ensureAuth() {
                if (window.auth) {
                    return Promise.resolve(window.auth);
                } else {
                    console.error("Firebase not loaded correctly.");
                    alert("Erro de conexão. Por favor recarregue a página.");
                    return Promise.reject("Firebase unavailable");
                }
            }

            // Initialize Auth Persistence
            if (window.auth) {
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(() => { });
            }

            // Toggle Signup/Login Mode (Delegated)
            const authFooter = document.getElementById('authFooter');
            const nameGroup = document.getElementById('nameGroup');
            const authTitle = document.querySelector('.auth-card h2');
            let isSignupMode = false;

            if (authFooter) {
                authFooter.addEventListener('click', (e) => {
                    if (e.target.id === 'toggleSignupBtn' || e.target.id === 'toggleLoginBtn') {
                        e.preventDefault();
                        isSignupMode = !isSignupMode;

                        if (isSignupMode) {
                            nameGroup.classList.remove('hidden'); // Remove !important class
                            nameGroup.style.display = 'block';
                            authTitle.textContent = 'Criar Conta';
                            loginBtn.textContent = 'Registar';
                            authFooter.innerHTML = 'Já tens conta? <a href="#" id="toggleLoginBtn">Entrar</a>';
                        } else {
                            nameGroup.classList.add('hidden'); // Add !important class
                            nameGroup.style.display = 'none';
                            authTitle.textContent = 'Área Reservada';
                            loginBtn.textContent = 'Entrar';
                            authFooter.innerHTML = 'Ainda não és membro? <a href="#" id="toggleSignupBtn">Subscrever agora</a>';
                        }
                    }
                });
            }

            // Login/Signup Action
            if (loginBtn) {
                loginBtn.addEventListener('click', async () => {
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    const name = document.getElementById('signupName').value;

                    if (!email || !password) {
                        alert("Por favor preencha email e password.");
                        return;
                    }

                    if (isSignupMode && !name) {
                        alert("Por favor diz-nos o teu nome.");
                        return;
                    }

                    const originalText = loginBtn.textContent;
                    loginBtn.textContent = "A processar...";
                    loginBtn.disabled = true;

                    // Ensure auth is ready
                    await ensureAuth();

                    try {
                        const db = window.db; // helper

                        if (isSignupMode) {
                            // --- INTELLIGENT REGISTRATION ---

                            // 1. Check if user already exists in DB (even if Auth is missing/messy)
                            let existingStatus = null;
                            if (db) {
                                const docCheck = await db.collection("users").doc(email).get();
                                if (docCheck.exists) {
                                    existingStatus = docCheck.data().status;
                                }
                            }

                            if (existingStatus === 'active') {
                                alert("Já existe uma conta ativa com este email! Por favor faz Login.");
                                loginBtn.textContent = originalText;
                                loginBtn.disabled = false;
                                document.getElementById('toggleLoginBtn').click(); // Switch to login
                                return;
                            } else if (existingStatus === 'pending' || existingStatus === 'inactive') {
                                // User exists but needs to pay
                                if (confirm("Já tens conta criada, mas a subscrição não está ativa. Queres reativar agora?")) {
                                    // TRIGGER STRIPE
                                    // Use 'startSubscription' from script.js, but we need to ensure we are logged in first? 
                                    // Actually, createCheckoutSession requires Auth.
                                    // So we must log them in.
                                    try {
                                        await window.auth.signInWithEmailAndPassword(email, password);
                                        await window.startSubscription('dashboard.html');
                                        return; // Redirecting...
                                    } catch (e) {
                                        alert("Por favor faz login com a tua password para reativar.");
                                        document.getElementById('toggleLoginBtn').click();
                                        return;
                                    }
                                }
                                loginBtn.textContent = originalText;
                                loginBtn.disabled = false;
                                return;
                            }

                            // 2. Create New User
                            let userCredential;
                            try {
                                userCredential = await window.auth.createUserWithEmailAndPassword(email, password);
                            } catch (err) {
                                if (err.code === 'auth/email-already-in-use') {
                                    alert("Este email já está registado. Tente fazer Login.");
                                    document.getElementById('toggleLoginBtn').click();
                                    loginBtn.textContent = originalText;
                                    loginBtn.disabled = false;
                                    return;
                                }
                                throw err;
                            }

                            const user = userCredential.user;

                            // 3. Save User to Firestore with 'pending' status
                            try {
                                if (db) {
                                    await db.collection("users").doc(email).set({
                                        uid: user.uid,
                                        name: name,
                                        email: email,
                                        status: 'pending', // Default status
                                        createdAt: new Date(),
                                        lastLogin: new Date()
                                    });
                                }
                                // Update Auth Profile
                                if (user.updateProfile) {
                                    await user.updateProfile({ displayName: name });
                                }

                                // 4. IMMEDIATE REDIRECT TO PAYMENT
                                if (confirm("Conta criada! Vamos ativar a tua subscrição?")) {
                                    await window.startSubscription('dashboard.html');
                                } else {
                                    alert("Podes ativar a subscrição mais tarde fazendo login.");
                                    window.location.reload();
                                }

                            } catch (error) {
                                console.error("Error saving profile:", error);
                                alert("Erro ao guardar perfil. Contacte o suporte.");
                            }

                        } else {
                            // --- LOGIN ---
                            const userCredential = await window.auth.signInWithEmailAndPassword(email, password);
                            const user = userCredential.user;

                            // 1. Check Status in Firestore
                            let userNameFromDb = '';
                            if (window.db) {
                                const docSnap = await window.db.collection("users").doc(user.email).get();

                                if (docSnap.exists) {
                                    const userData = docSnap.data();
                                    userNameFromDb = userData.name;

                                    if (userData.status === 'pending' || userData.status === 'inactive') {
                                        // Show Payment Option
                                        if (confirm("A tua conta está pendente/inativa. Queres ativar a subscrição agora?")) {
                                            await window.startSubscription('dashboard.html');
                                            return;
                                        }
                                        // Allow login but they won't force logout here, 
                                        // dashboard.html handles the lock if they proceed without paying.
                                        // But maybe we should block here? dashboard.html has the modal.
                                        // Let's rely on dashboard.html modal.
                                    }

                                    if (userData.status === 'blocked') {
                                        alert("Esta conta foi suspensa. Contacta a administração.");
                                        await window.auth.signOut();
                                        loginBtn.textContent = originalText;
                                        loginBtn.disabled = false;
                                        return;
                                    }

                                    // If active, update last login
                                    window.db.collection("users").doc(user.email).update({
                                        lastLogin: new Date()
                                    }).catch(e => console.log("Erro a atualizar lastLogin", e));
                                } else {
                                    // Legacy/Sync Issue
                                    try {
                                        await window.db.collection("users").doc(user.email).set({
                                            uid: user.uid,
                                            name: user.displayName || name || 'Membro',
                                            email: user.email,
                                            status: 'active', // Assume legacy users are active? Or pending? Safer pending.
                                            createdAt: new Date(),
                                            lastLogin: new Date()
                                        });
                                    } catch (e) { }
                                }
                            }

                            // Success Handling
                            localStorage.setItem('userEmail', user.email);
                            localStorage.setItem('isMember', 'true');
                            const finalName = user.displayName || userNameFromDb || 'Membro';
                            localStorage.setItem('userName', finalName);

                            window.location.href = 'dashboard.html';
                        }

                    } catch (error) {
                        console.error("Auth Failed:", error);
                        let msg = "Erro desconhecido: " + error.message;

                        if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                            msg = "Email ou Password inválidos.";
                        } else if (error.code === 'auth/weak-password') {
                            msg = "A password deve ter pelo menos 6 caracteres.";
                        }

                        alert(msg);
                        loginBtn.textContent = originalText;
                        loginBtn.disabled = false;
                    }
                });
            } else {
                console.error("Button not found");
            }

            // Password Toggle
            const togglePasswordBtn = document.getElementById('togglePassword');
            if (togglePasswordBtn) {
                togglePasswordBtn.addEventListener('click', (e) => {
                    // Prevent form submission if any
                    e.preventDefault();

                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);

                    // Update icon by replacing innerHTML
                    if (type === 'text') {
                        togglePasswordBtn.innerHTML = '<i data-lucide="eye-off"></i>';
                    } else {
                        togglePasswordBtn.innerHTML = '<i data-lucide="eye"></i>';
                    }
                    lucide.createIcons();
                });
            }

            // Allow Enter key
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') loginBtn.click();
                });
            }
        });
    </script>
</body>

</html>