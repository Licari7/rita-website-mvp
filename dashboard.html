<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Área de Membros | Floresce Terapias</title>
    <script src="theme-loader.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Montserrat:wght@300;400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=7.1.5">
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="init-firebase.js?v=3.1.0"></script>
    <script src="cms.js?v=7.2.1"></script>
    <script src="cms-services.js?v=2.3.0"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        /* Hide API Key Warning - Minimal & Safe */
        .tox-notifications-container,
        .tox-statusbar__branding,
        .tox-promotion {
            display: none !important;
        }

        /* Accordion Styles */
        details.admin-card {
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        details.admin-card[open] {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        details.admin-card.dragging {
            opacity: 0.5;
            border: 2px dashed #ccc;
        }

        summary.admin-card-header {
            padding: 12px 16px;
            cursor: move;
            font-weight: 600;
            font-family: var(--font-serif);
            font-size: 13px;
            /* Exact Request */
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            align-items: center;
            list-style: none;
            color: var(--color-primary);
            background: #fff;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .drag-handle {
            cursor: move;
            color: #ccc;
            display: flex;
            align-items: center;
        }

        summary.admin-card-header:hover {
            background: #fcfcfc;
        }

        summary.admin-card-header::after {
            content: '+';
            font-size: 1.2em;
            /* Adjusted for smaller header */
            font-weight: 300;
            color: #999;
            transition: transform 0.2s;
        }

        details.admin-card[open] summary.admin-card-header::after {
            content: '-';
            transform: rotate(0deg);
        }

        /* Hide default marker in Webkit */
        summary.admin-card-header::-webkit-details-marker {
            display: none;
        }

        .admin-card-body {
            padding: 6px;
            /* Exact Request */
            border-top: 1px solid #eee;
            background: #fafafa;
            animation: slideDown 0.3s ease-out;
            cursor: default !important;
            font-size: 12px;
            /* Exact Request */
            color: #1f2937;
            /* Dark Gray */
        }

        /* Compact form groups inside admin cards */
        .admin-card-body .form-group {
            margin-bottom: 8px;
            /* Tighter layout */
        }

        /* Ensure all inputs and labels inside obey the 12px rule */
        .admin-card-body label {
            font-size: 12px;
            margin-bottom: 2px;
            display: block;
            font-weight: 600;
            color: #111827;
            /* Darker Label */
        }

        .admin-card-body input,
        .admin-card-body select,
        .admin-card-body textarea,
        .admin-card-body button {
            font-size: 12px !important;
            padding: 1px;
            /* Slightly reduced padding for inputs */
            color: #000 !important;
            /* Force Black */
        }

        .admin-card-body h3 {
            font-size: 13px;
            margin-bottom: 10px;
            color: #111827;
            /* Dark Title */
        }



        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 3-Column CMS Layout */
        .admin-grid-3-col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .admin-grid-3-col {
                grid-template-columns: 1fr;
            }
        }

        .admin-col-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .admin-col-header {
            font-family: var(--font-serif);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-primary);
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .preview-box-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .preview-box-item {
            flex: 1;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .cta-toggle-group {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #eee;
        }

        /* Dashboard specific container override for wider layout */
        .dashboard-page .container {
            max-width: 1400px;
        }

        .cms-version-tag {
            font-size: 10px;
            color: #888;
            margin-left: 10px;
        }

        .testimonial-scroll-area {
            max-height: 200px;
            overflow-y: auto;
        }

        .text-nowrap {
            white-space: nowrap;
        }

        @media (max-width: 1200px) {
            .admin-grid-3-col {
                grid-template-columns: 1fr 1fr;
                /* 2 cols */
            }

            .admin-col-card:nth-child(3) {
                grid-column: span 2;
                /* Section 2 takes full width below */
            }
        }

        @media (max-width: 768px) {
            .admin-grid-3-col {
                grid-template-columns: 1fr;
                /* Stack */
            }

            .admin-col-card:nth-child(3) {
                grid-column: auto;
            }
        }

        .admin-grid-2-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .admin-grid-2-col {
                grid-template-columns: 1fr;
            }
        }

        .update-members-link {
            margin-left: 8px;
            font-size: 11px;
            font-weight: 400;
            color: var(--color-primary);
            text-decoration: underline;
            font-family: var(--font-sans);
        }
    </style>
</head>

<body class="dashboard-page">



    <!-- Navigation -->
    <nav class="navbar navbar-always-solid">
        <div class="container nav-content">
            <div class="brand-container">
                <a href="index.html" class="logo-link" aria-label="site público">
                    <img id="header-logo-display" src="" alt="Logo" class="header-logo hidden">
                </a>
                <div class="brand-info">
                    <a href="index.html" class="logo">Floresce Terapias</a>
                    <div class="header-socials">
                        <a href="https://www.instagram.com/floresceterapias?igsh=MW90eXlmOG93em55ZA%3D%3D&utm_source=qr"
                            target="_blank" rel="noopener noreferrer" aria-label="Instagram"><i
                                data-lucide="instagram"></i></a>
                        <a href="https://wa.me/351913515406" target="_blank" rel="noopener noreferrer"
                            aria-label="WhatsApp"><i data-lucide="message-circle"></i></a>
                    </div>
                </div>
            </div>

            <ul class="nav-links">
                <li><a href="index.html">Início</a></li>
                <li><a href="index.html#about">Sobre</a></li>
                <li><a href="index.html#services">Serviços</a></li>
                <li><a href="index.html#events">Eventos</a></li>
                <li><a href="booking.html">Agendar</a></li>
                <li><a href="dashboard.html" class="active">Área de Membros</a></li>
            </ul>

            <div class="nav-actions">
                <span id="user-name-display" class="desktop-only user-name-display">Visitante</span>
                <a href="#" id="logout-btn" class="btn btn-outline btn-sm">Sair</a>
            </div>

            <!-- Welcome Message (New Location) -->
            <!-- Welcome Message (New Location) -->
            <!-- Welcome Message -->
            <span id="header-welcome-msg" class="header-welcome-msg"></span>

            <button class="menu-toggle" aria-label="Menu">
                <i data-lucide="menu"></i>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu">
        <!-- Content injected by sidebar.js -->
    </div>

    <!-- Main Content -->
    <main class="container section-padding">
        <header class="section-header text-center mb-40">
            <h1 id="main-dashboard-title" class="section-title">As Minhas Meditações</h1>
            <!-- Removed welcome message from here -->
            <!-- <p>Acede aqui aos teus recursos e meditações.</p> -->
            <button id="admin-toggle-btn" class="cta-button admin-toggle-btn">
                <i data-lucide="settings"></i> Gerir Site
            </button>
        </header>

        <!-- ADMIN PANEL (Hidden by Default) -->
        <section id="admin-panel" class="admin-panel-container">
            <h2 class="admin-panel-title">
                Painel de Administração
            </h2>

            <div id="dashboard-cards-container">
                <!-- 0. MAINTENANCE MODE ACCORDION (NEW) -->
                <details class="admin-card draggable-card maintenance-card" id="card-maintenance">
                    <summary class="admin-card-header maintenance-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="power" class="admin-icon"></i> Estado do Site</span>
                        <span id="maintenance-header-badge"
                            class="maintenance-badge online maintenance-header-pos">ONLINE</span>
                    </summary>
                    <div class="admin-card-body">
                        <div class="admin-panel-content">
                            <p class="font-sm mb-15">Usa este interruptor para colocar o site em modo "Em Construção".
                                Quando ativo, os visitantes precisarão de uma password para aceder ao site.</p>
                            <form id="maintenance-form" class="auth-form"
                                onsubmit="event.preventDefault(); window.saveMaintenanceConfig();">
                                <div class="form-group-row flex-gap-20-center bg-whitesmoke-rounded mb-15 p-15">
                                    <div class="flex-align-center-gap-10">
                                        <input type="checkbox" id="maintenance-toggle"
                                            class="w-18-h-18 margin-0 cursor-pointer"
                                            onchange="window.updateMaintenanceVisuals()">
                                        <label for="maintenance-toggle" class="maintenance-badge online"
                                            id="maintenance-status-label">ONLINE</label>
                                    </div>
                                </div>
                                <div class="form-group d-none" id="maintenance-password-group">
                                    <label class="font-weight-600">Password de Acesso</label>
                                    <input type="text" id="maintenance-password" placeholder="Ex: floresce2024"
                                        class="admin-input full-width">
                                    <small class="admin-help-text">A password que os visitantes terão de inserir para
                                        entrar (Mínimo 4 caracteres). Só é necessária em modo Offline.</small>
                                </div>
                                <button type="submit" id="maintenance-save-btn"
                                    class="cta-button primary full-width">Guardar Estado</button>
                            </form>
                        </div>
                    </div>
                </details>

                <!-- 1. EVENTS ACCORDION -->
                <details class="admin-card draggable-card" id="card-events">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="calendar" class="admin-icon"></i> Gestão de
                            Eventos</span>
                    </summary>
                    <div class="admin-card-body">
                        <div class="admin-grid-layout">
                            <!-- Add Event Form -->
                            <div>
                                <h3 class="admin-section-title">Adicionar Novo Evento
                                </h3>
                                <form id="event-form" class="auth-form">
                                    <input type="hidden" id="evt-id">
                                    <div class="form-group">
                                        <label>Título do Evento</label>
                                        <input type="text" id="evt-title" required placeholder="Ex: Workshop de Aura">
                                    </div>
                                    <div class="form-group-row">
                                        <div class="form-group form-group-half">
                                            <label>Data</label>
                                            <input type="date" id="evt-date" required>
                                        </div>
                                        <div class="form-group form-group-half">
                                            <label>Hora</label>
                                            <input type="time" id="evt-time" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Localização (Ex: Online Zoom)</label>
                                        <input type="text" id="evt-location" required
                                            placeholder="Ex: Lisboa ou Online">
                                    </div>
                                    <div class="form-group">
                                        <label>Descrição Curta</label>
                                        <textarea id="evt-desc" rows="3" placeholder="Descrição breve para o site"
                                            class="admin-textarea"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Imagem (Capa)</label>
                                        <input type="text" id="evt-image-url" class="admin-file-url-input margin-0"
                                            placeholder="URL da imagem (auto)" readonly>
                                        <div id="evt-image-preview" class="mb-5"></div>
                                        <input type="file" id="evt-image" accept="image/*">
                                    </div>
                                    <div class="form-group">
                                        <label>Link de Inscrição (Opcional)</label>
                                        <input type="text" id="evt-link" placeholder="#contact ou link externo">
                                    </div>
                                    <button type="submit" class="cta-button primary full-width">Publicar Evento</button>
                                </form>
                            </div>

                            <!-- Existing Events List -->
                            <div class="admin-list-container">
                                <div class="admin-header-flex">
                                    <h3 class="font-serif margin-0">Eventos Ativos</h3>
                                    <button type="button" onclick="window.resetEventForm()"
                                        class="btn btn-outline btn-sm font-sm">+ Novo</button>
                                </div>
                                <div id="admin-events-list">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- 2. HOME HERO ACCORDION -->
                <details class="admin-card draggable-card" id="card-home-hero">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="home" class="admin-icon"></i> Página Inicial (Hero)</span>
                    </summary>
                    <div class="admin-card-body">
                        <form id="home-content-form" class="auth-form">
                            <div class="form-group">
                                <label>Título Principal</label>
                                <input type="text" id="home-title" placeholder="Encontra espaço em ti...">
                            </div>
                            <div class="form-group">
                                <label>Subtítulo</label>
                                <input type="text" id="home-subtitle" placeholder="Leitura de Aura...">
                            </div>
                            <div class="form-group">
                                <input type="text" id="home-cta" placeholder="Descobrir Mais">
                            </div>

                            <!-- Readability Controls -->
                            <div class="form-group-row flex-gap-20-center bg-whitesmoke-rounded mb-15">
                                <div class="flex-align-center-gap-10">
                                    <label for="home-text-color" class="margin-0">Cor do Texto:</label>
                                    <input type="color" id="home-text-color" value="#f7f2e0" class="color-input">
                                </div>
                                <div class="flex-align-center-gap-10">
                                    <input type="checkbox" id="home-text-highlight" class="w-18-h-18 margin-0">
                                    <label for="home-text-highlight" class="margin-0 cursor-pointer">Fundo de
                                        Destaque?</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Imagem de Fundo (Opcional)</label>
                                <input type="text" id="home-image-url" placeholder="URL da imagem (ou upload abaixo)"
                                    class="admin-file-url-input margin-0">
                                <div id="home-image-preview" class="mb-5"></div>
                                <input type="file" id="home-image-file" accept="image/*">
                                <small class="admin-help-text">Substitui a cor verde por uma foto.</small>
                            </div>
                            <button type="submit" id="home-save-btn" class="cta-button primary full-width">Guardar
                                Início</button>
                        </form>
                    </div>
                </details>

                <!-- 3. HOME SUMMARY ACCORDION (New) -->
                <details class="admin-card draggable-card" id="card-home-summary">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="align-left" class="admin-icon"></i> Página Inicial (Resumo Sobre)</span>
                    </summary>
                    <div class="admin-card-body">
                        <form id="home-about-form" class="auth-form">
                            <div class="form-group">
                                <label>Título (Ex: Uma jornada de luz)</label>
                                <input type="text" id="home-about-title-input" placeholder="Título do resumo">
                            </div>
                            <div class="form-group">
                                <label>Texto do Resumo</label>
                                <textarea id="home-about-text-input" rows="4"
                                    placeholder="Breve texto introdutório que aparece na página inicial..."
                                    class="admin-textarea"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Imagem Lateral (Pequena)</label>
                                <input type="text" id="home-about-image-url" class="admin-file-url-input margin-0">
                                <div id="home-about-image-preview" class="mb-5"></div>
                                <input type="file" id="home-about-image-file" accept="image/*">
                            </div>
                            <button type="submit" id="home-about-save-btn" class="cta-button primary full-width">Guardar
                                Resumo</button>
                        </form>
                    </div>
                </details>

                <!-- 3. MEMBER MANAGEMENT ACCORDION (NEW) -->
                <details class="admin-card draggable-card" id="card-members">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="users" class="admin-icon"></i> Gestão de Membros</span>
                    </summary>
                    <div class="admin-card-body">
                        <div class="admin-panel-content" id="panel-members">
                            <div class="admin-header-flex members-header-flex">
                                <h3 class="font-serif margin-0">
                                    Lista de Membros
                                    <a href="#" onclick="event.preventDefault(); window.loadMembers();"
                                        title="Atualizar lista" class="update-members-link">↺
                                        Atualizar</a>
                                </h3>
                                <div class="members-actions-row">
                                    <button id="access-mode-toggle-btn" class="access-mode-toggle-btn"
                                        onclick="window.toggleAccessMode()">
                                        A carregar modo...
                                    </button>
                                </div>
                            </div>

                            <div id="admin-members-list" class="scrollable-list-500">
                                <p>A carregar membros...</p>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- 4. ABOUT PAGE FULL ACCORDION -->
                <details class="admin-card draggable-card" id="card-about-full">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="user" class="admin-icon"></i> Página "Sobre Mim" (Completa)</span>
                    </summary>
                    <div class="admin-card-body">
                        <form id="about-content-form" class="auth-form">
                            <div class="form-group">
                                <label>Título da Página</label>
                                <input type="text" id="about-title" placeholder="Uma jornada de luz">
                            </div>
                            <div class="form-group">
                                <label>Foto de Perfil (Intro)</label>
                                <input type="text" id="about-image-url" class="admin-file-url-input margin-0">
                                <div id="about-image-preview" class="mb-5"></div>
                                <input type="file" id="about-image-file" accept="image/*">
                            </div>
                            <div class="form-group">
                                <label>Texto Autoconhecimento</label>
                                <textarea id="about-text-intro" rows="6" placeholder="Texto da primeira secção..."
                                    class="admin-textarea"></textarea>
                            </div>

                            <hr class="admin-divider">

                            <div class="form-group">
                                <label>Foto Secção Arte (Opcional)</label>
                                <input type="text" id="about-image-art-url" class="admin-file-url-input margin-0">
                                <div id="about-image-art-preview" class="mb-5"></div>
                                <input type="file" id="about-image-art-file" accept="image/*">
                            </div>
                            <div class="form-group">
                                <label>Texto Arte</label>
                                <textarea id="about-text-art" rows="6" placeholder="Texto da secção Arte..."
                                    class="admin-textarea"></textarea>
                            </div>
                            <small class="admin-help-text">Aceita HTML básico.</small>

                            <!-- Colors for About Sections -->
                            <details class="sub-accordion mb-15 mt-20">
                                <summary class="font-serif font-weight-600 cursor-pointer p-10 bg-gray-light">
                                    <span><i data-lucide="palette" class="icon-sm"></i> Cores das Secções</span>
                                </summary>
                                <div class="p-10 mt-10 grid-2-col-gap-15">

                                    <!-- Section 1: Intro -->
                                    <div class="form-group full-width">
                                        <label class="font-bold border-bottom-light mb-5">Secção 1
                                            (Intro/Autora)</label>
                                        <div class="grid-2-col-gap-10">
                                            <div>
                                                <label>Fundo</label>
                                                <div class="flex-align-center-gap-5">
                                                    <input type="color" id="about-intro-bg" value="#ffffff"
                                                        class="color-preview-box">
                                                    <input type="text" id="about-intro-bg-hex" value="#ffffff"
                                                        class="color-hex-input-sm">
                                                </div>
                                            </div>
                                            <!-- Text Color Removed -->
                                        </div>
                                    </div>

                                    <!-- Section 2: Art -->
                                    <div class="form-group full-width">
                                        <label class="font-bold border-bottom-light mb-5">Secção 2 (A minha
                                            Arte)</label>
                                        <div class="grid-2-col-gap-10">
                                            <div>
                                                <label>Fundo</label>
                                                <div class="flex-align-center-gap-5">
                                                    <input type="color" id="about-art-bg" value="#f7f2e0"
                                                        class="color-preview-box">
                                                    <input type="text" id="about-art-bg-hex" value="#f7f2e0"
                                                        class="color-hex-input-sm">
                                                </div>
                                            </div>
                                            <!-- Text Color Removed -->
                                        </div>
                                    </div>

                                </div>
                            </details>
                            <button type="submit" id="about-save-btn" class="cta-button primary full-width">Guardar
                                Página Sobre</button>
                        </form>
                    </div>
                </details>

                <!-- 5. SERVICES ACCORDION -->
                <details class="admin-card draggable-card" id="card-services">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="sparkles" class="admin-icon"></i> Gestão de Serviços</span>
                    </summary>
                    <div class="admin-card-body">
                        <div class="admin-panel-content" id="panel-services">
                            <!-- Removed duplicate outer form -->

                            <!-- RE-DESIGNED LAYOUT: SINGLE COLUMN, CENTERED -->

                            <!-- 1. HEADER & NEW BTN -->
                            <div class="flex-column-center mb-20 width-100">
                                <button type="button" onclick="window.resetServiceForm()"
                                    class="cta-button outline small">+
                                    Novo Serviço</button>
                            </div>

                            <!-- General Section Config (Background) -->
                            <div class="width-100 flex-center mb-20">
                                <details class="admin-card-inner width-100 max-w-400">
                                    <summary class="font-xs cursor-pointer text-center text-muted">Configurar Imagem
                                        de Fundo (Geral)</summary>
                                    <div class="p-10 border-light mt-5 bg-gray-light border-radius-8">
                                        <form id="service-config-form"
                                            onsubmit="event.preventDefault(); window.handleServiceConfigSubmit();">
                                            <div class="form-group mb-10">
                                                <label class="font-xs text-muted mb-2 block">Título da Secção</label>
                                                <input type="text" id="service-section-title"
                                                    placeholder="Sessões Individuais"
                                                    class="admin-input-select font-xs">
                                            </div>

                                            <div class="form-group mb-10 border-bottom-light pb-10">
                                                <div class="flex-align-center-gap-10 mb-5">
                                                    <input type="checkbox" id="service-title-highlight-enabled"
                                                        class="w-auto">
                                                    <label for="service-title-highlight-enabled"
                                                        class="font-xs text-muted margin-0 cursor-pointer">Destaque
                                                        de Fundo?</label>
                                                </div>
                                                <div class="flex-align-center-gap-5">
                                                    <label class="font-xs text-muted margin-0">Cor:</label>
                                                    <input type="color" id="service-title-highlight-color"
                                                        value="#f7f2e0" class="input-color-sm">
                                                </div>

                                                <div class="flex-column gap-5 mt-10 border-top-light pt-5">
                                                    <div class="flex-between-center">
                                                        <label class="font-xs text-muted margin-0">Opacidade:</label>
                                                        <span id="service-title-opacity-val"
                                                            class="font-xs text-muted">100%</span>
                                                    </div>
                                                    <input type="range" id="service-title-highlight-opacity" min="0"
                                                        max="1" step="0.1" value="1" class="input-range-full"
                                                        oninput="document.getElementById('service-title-opacity-val').innerText = Math.round(this.value * 100) + '%'">
                                                </div>
                                            </div>

                                            <div class="form-group mb-5">
                                                <label class="font-xs text-muted mb-2 block">Imagem de Fundo
                                                    (Geral)</label>
                                                <div class="flex-align-center-gap-10 mb-5">
                                                    <input type="text" id="service-bg-url"
                                                        placeholder="URL da Imagem..."
                                                        class="admin-file-url-input margin-0 font-xs">
                                                    <button type="button" class="btn btn-outline btn-sm text-danger"
                                                        onclick="window.removeFileWithUrl('service-bg-url', 'service-bg-file')"
                                                        title="Remover Imagem"><i data-lucide="trash-2"
                                                            class="icon-14"></i></button>
                                                </div>
                                            </div>
                                            <div id="service-bg-preview" class="mb-5"></div>
                                            <div class="form-group mb-5">
                                                <input type="file" id="service-bg-file" accept="image/*"
                                                    class="font-xs">
                                            </div>
                                            <button type="button" id="service-config-btn"
                                                onclick="window.handleServiceConfigSubmit(event)"
                                                class="btn btn-sm btn-primary full-width">Guardar Fundo</button>
                                        </form>
                                    </div>
                                </details>
                            </div>

                            <!-- 2. ACTIVE SERVICES LIST (HORIZONTAL) -->
                            <div class="width-100 mb-30 text-center">
                                <h4 class="font-serif mb-10 text-muted margin-0">Serviços Ativos</h4>
                                <!-- Container for Horizontal List -->
                                <div id="admin-services-list" class="admin-service-list-horizontal">
                                    <!-- JS populates here -->
                                </div>
                            </div>

                            <!-- 3. EDITOR FORM (BELOW LIST) -->
                            <div class="admin-panel-content width-100 border-top-light pt-20">
                                <h3 class="font-serif mb-15 text-center">Dados do Serviço</h3>
                                <form id="service-form" onsubmit="event.preventDefault();">
                                    <input type="hidden" id="svc-id">

                                    <div>
                                        <!-- ROW 1: GENERAL INFO & TESTIMONIALS (2 COLUMNS) -->
                                        <div class="admin-grid-2-col mb-20">
                                            <!-- COLUMN 1: GENERAL INFO -->
                                            <div class="admin-col-card">
                                                <div class="admin-col-header flex-between-center">
                                                    <span>Informação Geral</span>
                                                    <button type="button" class="cta-button primary small"
                                                        onclick="window.handleServiceSubmit(event)">Atualizar
                                                        Serviço</button>
                                                </div>

                                                <div class="form-group mb-15">
                                                    <label class="block-mb-5 font-sm font-weight-600">Nome do
                                                        Serviço</label>
                                                    <input type="text" id="svc-title" class="admin-input full-width"
                                                        placeholder="Ex: Leitura de Aura">
                                                </div>

                                                <div class="form-group mb-15">
                                                    <label class="block-mb-5 font-sm">Benefícios (separar por
                                                        vírgula)</label>
                                                    <input type="text" id="svc-benefits"
                                                        class="admin-input full-width font-xs"
                                                        placeholder="Ex: Clareza, Paz, Cura...">
                                                </div>

                                                <div class="form-group mb-15">
                                                    <label class="block-mb-5 font-sm">Descrição Curta (Cartão)</label>
                                                    <textarea id="svc-desc"
                                                        class="admin-textarea input-sand full-width font-xs" rows="3"
                                                        placeholder="Resumo breve..."></textarea>
                                                </div>

                                                <div class="form-group mb-15">
                                                    <label class="block-mb-5 font-sm">Imagem do Cabeçalho
                                                        (Lista)</label>
                                                    <div class="grid-2-col-gap-10">
                                                        <div class="flex-align-center gap-5">
                                                            <input type="text" id="svc-image" placeholder="URL..."
                                                                class="admin-input-select font-xs flex-grow-1">
                                                            <!-- Fixed 'Remover Ficheiro' text/button -->
                                                            <button type="button"
                                                                class="btn-text-danger font-xs text-nowrap"
                                                                onclick="window.removeFileWithUrl('svc-image', 'svc-image-file')"
                                                                title="Remover ficheiro">
                                                                Remover Ficheiro
                                                            </button>
                                                        </div>
                                                        <input type="file" id="svc-image-file" accept="image/*"
                                                            class="font-xs">
                                                    </div>
                                                    <div id="svc-image-preview" class="mt-5"></div>
                                                </div>
                                            </div>

                                            <!-- COLUMN 2: TESTIMONIALS -->
                                            <div class="admin-col-card">
                                                <div class="admin-col-header flex-between-center">
                                                    <span class="flex-align-center gap-5">
                                                        Testemunhos
                                                        <span class="font-xs font-weight-normal text-muted">(Total:
                                                            <span id="svc-testimonials-total">0</span>)</span>
                                                    </span>
                                                    <button type="button" class="cta-button primary small"
                                                        onclick="window.handleServiceSubmit(event)">Atualizar</button>
                                                </div>

                                                <div class="form-group mb-15">
                                                    <div class="flex-between-center mb-5">
                                                        <label class="font-sm font-weight-600 flex-align-center gap-5">
                                                            Selecionar
                                                            <span
                                                                class="font-xs font-weight-normal text-muted">(Selecionados:
                                                                <span
                                                                    id="svc-testimonials-selected-count">0</span>)</span>
                                                        </label>
                                                        <div class="flex-align-center gap-5">
                                                            <input type="color" id="svc-testi-bg-color" value="#ffffff"
                                                                class="svc-testi-bg-input"
                                                                title="Cor de Fundo da Secção">
                                                        </div>
                                                        <button type="button" class="btn-text-primary font-xs"
                                                            onclick="window.openQuickTestimonialModal()">
                                                            <i data-lucide="plus-circle" class="icon-14"></i> Novo
                                                        </button>
                                                    </div>
                                                    <div id="loading-testimonials-selector" class="font-xs text-muted">A
                                                        carregar...</div>
                                                    <div id="svc-testimonials-selector"
                                                        class="testimonial-selector-grid testimonial-scroll-area">
                                                        <!-- Checkboxes injected here -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ROW 2: SECTIONS 1 & 2 (GRID) -->
                                        <div class="admin-grid-2-col">

                                            <!-- COLUMN 2: SECTION 1 -->
                                            <div class="admin-col-card">
                                                <div class="admin-col-header flex-between-center">
                                                    <span>Secção 1 (Topo)</span>
                                                    <button type="button" class="cta-button primary small"
                                                        onclick="window.handleServiceSubmit(event)">Atualizar</button>
                                                </div>

                                                <div class="form-group mb-15">
                                                    <label class="block-mb-5 font-sm">Título da Secção (H1)</label>
                                                    <input type="text" id="svc-sec1-title"
                                                        class="admin-input full-width"
                                                        placeholder="Título principal da página...">
                                                </div>

                                                <label class="block-mb-5 font-sm">Conteúdo (Cartão)</label>
                                                <textarea id="svc-full-desc"
                                                    class="admin-textarea input-sand property-editor mb-15" rows="8"
                                                    placeholder="Descrição principal..."></textarea>

                                                <!-- BACKGROUNDS CONFIG v3 -->
                                                <div class="preview-box-group">
                                                    <div class="preview-box-item">
                                                        <label class="font-xs block-mb-5 font-weight-600">Fundo da
                                                            Secção</label>
                                                        <div class="flex-align-center-gap-5 mb-5 justify-center">
                                                            <!-- Hidden actual inputs, simplified UI -->
                                                            <input type="color" id="svc-sec1-bg-color"
                                                                class="color-preview-box">
                                                            <span class="font-xs">Cor</span>
                                                        </div>
                                                        <div class="font-xs mb-5 text-muted">- OU -</div>
                                                        <div class="flex-align-center gap-5 mb-5">
                                                            <input type="text" id="svc-image-1" placeholder="URL Imagem"
                                                                class="admin-input-select font-xs width-100">
                                                        </div>
                                                        <div class="flex-align-center gap-5">
                                                            <input type="file" id="svc-image-1-file" accept="image/*"
                                                                class="font-xs width-100">
                                                            <button type="button"
                                                                class="btn-text-danger font-xs text-nowrap"
                                                                onclick="window.removeFileWithUrl('svc-image-1', 'svc-image-1-file')"
                                                                title="Remover ficheiro">
                                                                Remover
                                                            </button>
                                                        </div>
                                                        <div id="svc-image-1-preview" class="mt-5"></div>
                                                    </div>

                                                    <div class="preview-box-item">
                                                        <label class="font-xs block-mb-5 font-weight-600">Fundo do
                                                            Cartão</label>
                                                        <div class="flex-align-center-gap-5 mb-5 justify-center">
                                                            <input type="color" id="svc-card1-bg-color"
                                                                class="color-preview-box" value="#ffffff">
                                                        </div>
                                                        <label class="font-xs block-mb-5">Opacidade: <span
                                                                id="op-val-card1">90%</span></label>
                                                        <input type="range" id="svc-card1-opacity" min="0" max="1"
                                                            step="0.1" value="0.9"
                                                            oninput="document.getElementById('op-val-card1').textContent = Math.round(this.value * 100) + '%'"
                                                            class="full-width">
                                                    </div>
                                                </div>

                                                <!-- CTA BUTTONS -->
                                                <div class="cta-toggle-group">
                                                    <label class="block-mb-5 font-xs font-weight-600">Botões de
                                                        Ação</label>
                                                    <div class="flex-align-center-gap-10 mb-5">
                                                        <input type="checkbox" id="svc-sec1-cta-schedule">
                                                        <label for="svc-sec1-cta-schedule"
                                                            class="font-sm cursor-pointer mb-0">Mostrar
                                                            "Agendar"</label>
                                                    </div>
                                                    <div class="flex-align-center-gap-10">
                                                        <input type="checkbox" id="svc-sec1-cta-contact">
                                                        <label for="svc-sec1-cta-contact"
                                                            class="font-sm cursor-pointer mb-0">Mostrar "Entrar em
                                                            contacto"</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- COLUMN 3: SECTION 2 -->
                                            <div class="admin-col-card">
                                                <div class="admin-col-header flex-between-center">
                                                    <span>Secção 2 (Detalhe)</span>
                                                    <button type="button" class="cta-button primary small"
                                                        onclick="window.handleServiceSubmit(event)">Atualizar</button>
                                                </div>

                                                <label class="block-mb-5 font-sm">Conteúdo (Cartão)</label>
                                                <textarea id="svc-full-desc-2"
                                                    class="admin-textarea input-sand property-editor mb-15" rows="12"
                                                    placeholder="Mais detalhes..."></textarea>

                                                <!-- BACKGROUNDS CONFIG v3 -->
                                                <div class="preview-box-group">
                                                    <div class="preview-box-item">
                                                        <label class="font-xs block-mb-5 font-weight-600">Fundo da
                                                            Secção</label>
                                                        <div class="flex-align-center-gap-5 mb-5 justify-center">
                                                            <input type="color" id="svc-sec2-bg-color"
                                                                class="color-preview-box">
                                                            <span class="font-xs">Cor</span>
                                                        </div>
                                                        <div class="font-xs mb-5 text-muted">- OU -</div>
                                                        <div class="flex-align-center gap-5 mb-5">
                                                            <input type="text" id="svc-image-2" placeholder="URL Imagem"
                                                                class="admin-input-select font-xs width-100">
                                                        </div>
                                                        <div class="flex-align-center gap-5">
                                                            <input type="file" id="svc-image-2-file" accept="image/*"
                                                                class="font-xs width-100">
                                                            <button type="button"
                                                                class="btn-text-danger font-xs text-nowrap"
                                                                onclick="window.removeFileWithUrl('svc-image-2', 'svc-image-2-file')"
                                                                title="Remover ficheiro">
                                                                Remover
                                                            </button>
                                                        </div>
                                                        <div id="svc-image-2-preview" class="mt-5"></div>
                                                    </div>

                                                    <div class="preview-box-item">
                                                        <label class="font-xs block-mb-5 font-weight-600">Fundo do
                                                            Cartão</label>
                                                        <div class="flex-align-center-gap-5 mb-5 justify-center">
                                                            <input type="color" id="svc-card2-bg-color"
                                                                class="color-preview-box" value="#ffffff">
                                                        </div>
                                                        <label class="font-xs block-mb-5">Opacidade: <span
                                                                id="op-val-card2">90%</span></label>
                                                        <input type="range" id="svc-card2-opacity" min="0" max="1"
                                                            step="0.1" value="0.9"
                                                            oninput="document.getElementById('op-val-card2').textContent = Math.round(this.value * 100) + '%'"
                                                            class="full-width">
                                                    </div>
                                                </div>

                                                <!-- CTA BUTTONS -->
                                                <div class="cta-toggle-group">
                                                    <label class="block-mb-5 font-xs font-weight-600">Botões de
                                                        Ação</label>
                                                    <div class="flex-align-center-gap-10 mb-5">
                                                        <input type="checkbox" id="svc-sec2-cta-schedule">
                                                        <label for="svc-sec2-cta-schedule"
                                                            class="font-sm cursor-pointer mb-0">Mostrar
                                                            "Agendar"</label>
                                                    </div>
                                                    <div class="flex-align-center-gap-10 mb-10">
                                                        <input type="checkbox" id="svc-sec2-cta-contact">
                                                        <label for="svc-sec2-cta-contact"
                                                            class="font-sm cursor-pointer mb-0">Mostrar "Entrar em
                                                            contacto"</label>
                                                    </div>
                                                    <!-- VISIBILITY TOGGLE -->
                                                    <div class="flex-align-center-gap-10 border-top-light pt-10">
                                                        <input type="checkbox" id="svc-sec2-visible" checked>
                                                        <label for="svc-sec2-visible"
                                                            class="font-sm cursor-pointer mb-0 font-weight-600 text-primary">
                                                            Mostrar Seçção 2 (Visível)
                                                        </label>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </form>

                                <!-- QUICK TESTIMONIAL MODAL (Matches existing structure) -->
                                <div id="quick-testimonial-modal" class="modal-overlay">
                                    <div class="modal-card">
                                        <button type="button" class="modal-close-btn"
                                            onclick="window.closeQuickTestimonialModal()"><i
                                                data-lucide="x"></i></button>
                                        <div class="modal-header">
                                            <h3 class="modal-title">Novo Testemunho Rápido</h3>
                                        </div>
                                        <form id="quick-testimonial-form"
                                            onsubmit="window.handleQuickTestimonialSubmit(event)">
                                            <input type="hidden" id="quick-rev-id">
                                            <div class="modal-form-group">
                                                <label class="modal-label">Nome</label>
                                                <input type="text" id="quick-rev-name" required
                                                    class="input-sand full-width" placeholder="Ex: Maria Silva">
                                            </div>
                                            <div class="modal-form-group">
                                                <label class="modal-label">Título/Role (opcional)</label>
                                                <input type="text" id="quick-rev-role" class="input-sand full-width"
                                                    placeholder="Ex: Cliente de Leitura de Aura">
                                            </div>
                                            <div class="modal-form-group">
                                                <label class="modal-label">Depoimento</label>
                                                <textarea id="quick-rev-text" required rows="4"
                                                    class="input-sand full-width admin-textarea"
                                                    placeholder="Escreva o testemunho aqui..."></textarea>
                                            </div>
                                            <div class="flex-end-gap-10 mt-20">
                                                <button type="button" class="btn btn-outline small"
                                                    onclick="window.closeQuickTestimonialModal()">Cancelar</button>
                                                <button type="submit" class="cta-button primary small">Guardar &
                                                    Associar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ACTIONS -->
                        <div class="admin-action-bar">
                            <button type="button" id="svc-submit-btn" onclick="window.handleServiceSubmit(event)"
                                class="cta-button primary min-w-200"
                                title="Cria o novo serviço com todas as informações preenchidas (Cartão Principal, Detalhes e Testemunhos)">Publicar
                                Serviço</button>
                            <button type="button" id="svc-cancel-btn" class="btn btn-outline hidden"
                                onclick="window.resetServiceForm()">Cancelar Edição</button>
                            <span class="cms-version-tag">CMS v3.0.1</span>
                            <div class="flex-grow"></div>

                            <!-- Background Config moved here as utility -->
                            <details class="admin-card-inner hidden">
                                <summary class="font-xs cursor-pointer">Configurar Fundo da Secção</summary>
                                <div class="p-10 border-top-light mt-10">
                                    <form id="service-config-form"
                                        onsubmit="event.preventDefault(); window.handleServiceConfigSubmit();">
                                        <div class="form-group mb-5">
                                            <input type="text" id="service-bg-url" placeholder="URL da Imagem..."
                                                class="admin-input-select font-xs">
                                        </div>
                                        <div id="service-bg-preview" class="mb-5"></div>
                                        <div class="form-group mb-5">
                                            <input type="file" id="service-bg-file" accept="image/*" class="font-xs">
                                        </div>
                                        <button type="button" id="service-config-btn"
                                            onclick="window.handleServiceConfigSubmit(event)"
                                            class="btn btn-sm btn-primary full-width">Guardar Fundo</button>
                                    </form>
                                </div>
                            </details>
                        </div>
                    </div>
                </details>

                <!-- 5.2 HTML GENERATOR (STYLE ASSISTANT) -->
                <details class="admin-card draggable-card" id="card-html-generator">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="code" class="admin-icon"></i> Gerador de Estilos (HTML)</span>
                    </summary>
                    <div class="admin-card-body">
                        <div class="admin-panel-content">
                            <p class="font-xs mb-10 text-muted">
                                Utilize este editor para criar textos com design (negrito, itálico, cores).
                                Quando terminar, clique no botão para copiar o código HTML e cole-o
                                nos campos de texto simples (ex: Biografia, Serviços).
                            </p>

                            <div class="form-group">
                                <textarea id="html-generator-editor" class="admin-textarea" rows="10"></textarea>
                            </div>

                            <div class="admin-action-bar mt-10">
                                <button type="button" class="cta-button primary full-width"
                                    onclick="window.copyGeneratedHTML()">
                                    <i data-lucide="copy"></i> Copiar Código HTML
                                </button>
                                <button type="button" class="btn btn-outline" onclick="window.clearHtmlGenerator()">
                                    Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- 5.5 HEADER MANAGEMENT -->


                <!-- 6. TESTIMONIALS ACCORDION -->
                <details class="admin-card draggable-card" id="card-testimonials">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="message-circle" class="admin-icon"></i> Gestão de Testemunhos</span>
                    </summary>
                    <div class="admin-card-body">
                        <div class="admin-grid-2-col-gap-40">
                            <!-- Add Review Form -->
                            <div>
                                <h3 class="font-serif mb-15">Adicionar Novo
                                    Testemunho</h3>
                                <form id="review-form" class="auth-form">
                                    <div class="form-group">
                                        <label>Nome do Cliente</label>
                                        <input type="text" id="rev-name" required placeholder="Ex: Maria Silva">
                                    </div>
                                    <div class="form-group">
                                        <label>Título/Role (Opcional)</label>
                                        <input type="text" id="rev-role" placeholder="Ex: Cliente de Leitura de Aura">
                                    </div>
                                    <div class="form-group">
                                        <label>Mensagem</label>
                                        <textarea id="rev-text" rows="3" required placeholder="O testemunho..."
                                            class="admin-textarea"></textarea>
                                    </div>
                                    <button type="submit" class="cta-button primary full-width">Publicar
                                        Testemunho</button>
                                </form>
                            </div>

                            <!-- Existing Reviews List -->
                            <div class="admin-list-container">
                                <h3 class="font-serif mb-15">Testemunhos Ativos</h3>
                                <div id="admin-reviews-list">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- 7. MEDITATIONS ACCORDION -->
                <details class="admin-card draggable-card" id="card-meditations">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="headphones" class="admin-icon"></i> Gestão de Meditações</span>
                    </summary>
                    <div class="admin-card-body">
                        <div class="admin-grid-2-col-gap-40">
                            <!-- Add Meditation Form -->
                            <div>
                                <h3 class="font-serif mb-15">Adicionar
                                    Meditação/Recurso</h3>
                                <form id="meditation-form" class="auth-form">
                                    <input type="hidden" id="med-id">

                                    <!-- THEME SPECIFIC CARD TEXTS -->
                                    <div class="form-group mb-20 border-bottom-light pb-20">
                                        <label class="block-mb-8 font-serif">Textos dos Cartões por Tema</label>
                                        <p class="font-xs text-muted mb-10">Define aqui o texto 'Explorar...' específico
                                            para cada grupo q aparece na Dashboard.</p>

                                        <div id="theme-card-texts-container" class="grid-2-col-gap-10">
                                            <p class="font-xs text-muted">A carregar temas...</p>
                                        </div>

                                        <div class="mt-10 text-right">
                                            <button type="button" id="save-card-texts-btn"
                                                class="btn btn-sm btn-outline"
                                                onclick="window.saveThemeCardTexts()">Guardar Textos dos Temas</button>
                                        </div>
                                    </div>

                                    <!-- SECTION 1: Presentation Card (Dashboard) -->
                                    <h4 class="font-serif admin-section-header">
                                        1. Cartão de Apresentação (Dashboard)</h4>

                                    <div class="form-group">
                                        <label>Nome do Tema (Título do Cartão)</label>
                                        <input type="text" id="med-card-title" required placeholder="Ex: Enraizamento">
                                        <small class="hint-text">Aparece na capa do cartão.</small>
                                    </div>

                                    <div class="form-group">
                                        <label>Texto de Apresentação</label>
                                        <textarea id="med-card-text" rows="2"
                                            placeholder="Ex: Uma prática para voltar à terra..."></textarea>
                                    </div>

                                    <div class="grid-2-col-gap-15">
                                        <div class="form-group">
                                            <label>Tipo de Fundo</label>
                                            <select id="med-card-bg-type" onchange="toggleMedBgType()">
                                                <option value="image">Imagem</option>
                                                <option value="color">Cor Sólida</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Opacidade do Fundo (0.0 - 1.0)</label>
                                            <input type="number" id="med-card-opacity" step="0.1" min="0.0" max="1.0"
                                                value="0.6">
                                        </div>
                                    </div>

                                    <!-- Background Options (Toggled via JS) -->
                                    <div id="med-bg-image-group" class="form-group">
                                        <label>Imagem de Fundo (Capa)</label>
                                        <input type="text" id="med-image-url" placeholder="URL da imagem (auto)"
                                            class="admin-file-url-input margin-0" readonly>
                                        <div id="med-image-preview" class="mb-5"></div>
                                        <input type="file" id="med-image" accept="image/*">
                                    </div>

                                    <div id="med-bg-color-group" class="form-group admin-color-group">
                                        <label>Cor de Fundo</label>
                                        <div class="flex-gap-5">
                                            <input type="color" id="med-card-bg-color" value="#80864f"
                                                class="color-preview-box">
                                            <input type="text" id="med-card-bg-color-hex" value="#80864f"
                                                class="color-hex-input">
                                        </div>
                                    </div>

                                    <!-- SECTION 2: Detail Content -->
                                    <h4 class="font-serif admin-section-header mt-20">
                                        2. Conteúdo / Detalhe (Página Interior)</h4>

                                    <div class="grid-2-col-gap-15">
                                        <div class="form-group">
                                            <label>Título da Página (H1)</label>
                                            <input type="text" id="med-page-title"
                                                placeholder="Ex: Enraizamento Profundo">
                                        </div>
                                        <div class="form-group">
                                            <label>Subtítulo da Página</label>
                                            <input type="text" id="med-page-subtitle"
                                                placeholder="Ex: Uma viagem ao centro da terra">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>Título do Recurso (Interno/Lista)</label>
                                        <input type="text" id="med-title" required
                                            placeholder="Ex: Meditação Guiada #1">
                                    </div>

                                    <div class="grid-2-col-gap-15">
                                        <div class="form-group">
                                            <label>Estilo Visual (Tema)</label>
                                            <select id="med-theme">
                                                <option value="enraizamento">Verde (Enraizamento)</option>
                                                <option value="limpeza">Azul (Limpeza)</option>
                                                <option value="protecao">Roxo (Proteção)</option>
                                                <option value="intuicao">Laranja (Intuição)</option>
                                                <option value="chakras">Violeta (Chakras)</option>
                                                <option value="innerdance">Escuro (Innerdance)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Tipo de Recurso</label>
                                            <select id="med-type">
                                                <option value="audio">Áudio</option>
                                                <option value="video">Vídeo</option>
                                                <option value="pdf">PDF / Texto</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>URL do Recurso (MP3, YouTube, PDF)</label>
                                        <input type="text" id="med-url" placeholder="https://...">

                                        <div id="current-resource-display"
                                            class="hidden p-10 bg-white border-radius-8 mb-10 resource-display">
                                            <div class="flex-between-center">
                                                <div>
                                                    <small class="text-muted block font-xs">Ficheiro/Link Atual:</small>
                                                    <strong id="current-filename"
                                                        class="font-sm text-primary text-break-all">-</strong>
                                                </div>
                                                <button type="button" class="btn-text btn-remove-sm"
                                                    onclick="clearMeditationResource()">REMOVER ❌</button>
                                            </div>
                                        </div>

                                        <div class="mt-10 p-10 bg-gray-light border-radius-8 border-light">
                                            <label class="font-xs text-muted mb-5 block">Ou carregue um ficheiro de
                                                Áudio
                                                (MP3/WAV)</label>
                                            <div class="flex-align-center-gap-10 mb-5">
                                                <input type="text" id="med-audio-url-hidden" class="hidden">
                                                <input type="file" id="med-audio-file" accept="audio/*"
                                                    class="font-xs full-width margin-0">
                                            </div>
                                            <div id="med-audio-preview" class="mt-5"></div>

                                            <!-- Progress Bar -->
                                            <div id="audio-upload-progress" class="hidden mt-10">
                                                <div class="progress-bar-container progress-track">
                                                    <div id="audio-progress-bar" class="progress-fill">
                                                    </div>
                                                </div>
                                                <p id="audio-progress-text" class="font-xs text-center mt-5 text-muted">
                                                    A
                                                    carregar... 0%</p>
                                            </div>

                                            <small class="font-xs text-muted block mt-2">Isto irá gerar um link e
                                                preencher
                                                o campo acima automaticamente.</small>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>Descrição Completa</label>
                                        <textarea id="med-desc" class="admin-textarea" rows="4"></textarea>
                                    </div>

                                    <div class="form-actions mt-20">
                                        <button type="submit" id="med-submit-btn"
                                            class="cta-button primary full-width">Publicar Recurso</button>
                                        <button type="button" id="med-cancel-btn"
                                            class="btn-outline full-width mt-10 hidden"
                                            onclick="resetMeditationForm()">Cancelar Edição</button>
                                    </div>
                                </form>
                            </div>

                            <!-- Existing Meditations List -->
                            <div class="admin-list-container">
                                <h3 class="font-serif mb-15">Recursos Ativos</h3>
                                <!-- Carousel Container -->
                                <!-- Grouped List Container -->
                                <div id="admin-meditations-list" class="mt-20">
                                    <p class="text-muted text-center p-20">A carregar lista...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>



                <!-- 9. CONTACT MANAGEMENT ACCORDION -->
                <details class="admin-card draggable-card" id="card-contact">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="phone" class="admin-icon"></i> Gestão de Contactos</span>
                    </summary>
                    <div class="admin-card-body">
                        <form id="contact-form" class="auth-form">
                            <div class="form-group">
                                <label>Título da Secção</label>
                                <input type="text" id="contact-title-input" placeholder="Ex: Vamos conversar?">
                            </div>
                            <div class="form-group">
                                <label>Subtítulo / Descrição</label>
                                <textarea id="contact-subtitle-input"
                                    placeholder="Ex: Tens dúvidas ou queres agendar? Envia uma mensagem." rows="2"
                                    class="admin-textarea"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="text" id="contact-email-input"
                                    placeholder="Ex: floresceterapias@gmail.com">
                            </div>
                            <div class="form-group">
                                <label>Telefone</label>
                                <input type="text" id="contact-phone-input" placeholder="Ex: +351 913 515 406">
                            </div>
                            <div class="form-group">
                                <label>Instagram</label>
                                <input type="text" id="contact-instagram-input" placeholder="Ex: @floresceterapias">
                            </div>
                            <button type="submit" class="cta-button primary full-width">Guardar Contactos</button>
                        </form>
                    </div>
                </details>

                <!-- 10. LEGAL CONTENT MANAGEMENT -->
                <details class="admin-card draggable-card" id="card-legal">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="scale" class="admin-icon"></i> Gestão de Termos e Privacidade</span>
                    </summary>
                    <div class="admin-card-body">
                        <form id="legal-form" class="auth-form">
                            <div class="form-group">
                                <label>Conteúdo (Termos, Privacidade, Cookies)</label>
                                <textarea id="legal-editor" rows="20" class="admin-textarea"></textarea>
                                <p class="text-sm text-muted mt-5">Use este editor para formatar o texto legal do site.
                                </p>
                            </div>
                            <button type="submit" class="cta-button primary full-width">Guardar Termos e
                                Privacidade</button>
                        </form>
                    </div>
                </details>

                <!-- 5. VISUAL CUSTOMIZATION (MERGED) -->
                <details class="admin-card draggable-card" id="card-theme">
                    <summary class="admin-card-header">
                        <div class="drag-handle"><i data-lucide="grip-vertical"></i></div>
                        <span><i data-lucide="palette" class="admin-icon"></i> Personalização Visual</span>
                    </summary>
                    <div class="admin-card-body">
                        <p class="text-muted mb-20">Gira todas as cores e estilos do site num só lugar.</p>

                        <!-- SECTION 1: GENERAL COLORS -->
                        <details class="sub-accordion mb-20" open>
                            <summary
                                class="font-serif font-weight-600 cursor-pointer p-10 bg-gray-light border-radius-4">
                                1. Cores Gerais
                            </summary>
                            <div class="p-10 mt-10">
                                <form id="theme-form" class="auth-form grid-2-col-gap-20">
                                    <!-- General Inputs -->
                                    <div class="form-group">
                                        <label>Fundo Geral (Background)</label>
                                        <div class="flex-align-center-gap-10">
                                            <input type="color" id="theme-bg" value="#80864f"
                                                class="color-preview-box-large">
                                            <input type="text" id="theme-bg-hex" value="#80864f" maxlength="7"
                                                class="color-text-input">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Texto Principal</label>
                                        <div class="flex-align-center-gap-10">
                                            <input type="color" id="theme-text" value="#f7f2e0"
                                                class="color-preview-box-large">
                                            <input type="text" id="theme-text-hex" value="#f7f2e0" maxlength="7"
                                                class="color-text-input">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Cor Primária (Destaques)</label>
                                        <div class="flex-align-center-gap-10">
                                            <input type="color" id="theme-primary" value="#BF897F"
                                                class="color-preview-box-large">
                                            <input type="text" id="theme-primary-hex" value="#BF897F" maxlength="7"
                                                class="color-text-input">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Cor Secundária 1 (Bege)</label>
                                        <div class="flex-align-center-gap-10">
                                            <input type="color" id="theme-secondary-1" value="#f7f2e0"
                                                class="color-preview-box-large">
                                            <input type="text" id="theme-secondary-1-hex" value="#f7f2e0" maxlength="7"
                                                class="color-text-input">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Cor Secundária 2 (Azul)</label>
                                        <div class="flex-align-center-gap-10">
                                            <input type="color" id="theme-secondary-2" value="#dac2b2"
                                                class="color-preview-box-large">
                                            <input type="text" id="theme-secondary-2-hex" value="#dac2b2" maxlength="7"
                                                class="color-text-input">
                                        </div>
                                    </div>

                                    <div class="col-span-full mt-10 flex-gap-15">
                                        <button type="submit" id="theme-save-btn" class="cta-button primary">Guardar
                                            Cores
                                            Gerais</button>
                                        <button type="button" id="theme-reset-btn"
                                            class="btn btn-outline border-red color-red">Restaurar Padrões</button>
                                    </div>
                                </form>
                            </div>
                        </details>

                        <!-- SECTION 2: HEADER -->
                        <details class="sub-accordion mb-20">
                            <summary
                                class="font-serif font-weight-600 cursor-pointer p-10 bg-gray-light border-radius-4">
                                2. Cabeçalho
                            </summary>
                            <div class="p-10 mt-10">
                                <!-- Header Form Moved Here -->
                                <form id="header-form">
                                    <!-- Logo and Settings copied from previous header panel -->
                                    <div class="form-group mb-20">
                                        <label>Logótipo (PNG/SVG Transparent)</label>
                                        <input type="file" id="header-logo-upload" accept="image/*">
                                        <small class="admin-help-text">Aparecerá à esquerda do texto.</small>
                                        <img id="admin-logo-preview" class="hidden admin-logo-preview-img" src=""
                                            alt="Preview">
                                    </div>
                                    <div class="form-group mb-20">
                                        <label class="flex-align-center-gap-10 cursor-pointer">
                                            <input type="checkbox" id="header-transparent" class="w-auto">
                                            <span><strong>Transparente no Topo?</strong></span>
                                        </label>
                                    </div>
                                    <div class="grid-2-col-gap-15 mb-15">
                                        <div class="form-group">
                                            <label>Cor de Fundo (Header)</label>
                                            <div class="flex-gap-5">
                                                <input type="color" id="header-bg-color" class="color-preview-box">
                                                <input type="text" id="header-bg-color-hex" maxlength="7"
                                                    class="color-hex-input">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Cor do Texto</label>
                                            <div class="flex-gap-5">
                                                <input type="color" id="header-text-color" class="color-preview-box">
                                                <input type="text" id="header-text-color-hex" maxlength="7"
                                                    class="color-hex-input">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid-2-col-gap-15">
                                        <div class="form-group">
                                            <label>Tamanho da Fonte (px)</label>
                                            <input type="number" id="header-font-size" value="16" min="10" max="30">
                                        </div>
                                        <div class="form-group">
                                            <label>Padding Vertical (px)</label>
                                            <input type="number" id="header-padding" value="20" min="5" max="50">
                                        </div>
                                    </div>
                                    <button type="submit" id="header-save-btn"
                                        class="cta-button primary full-width mt-10">Guardar Cabeçalho</button>
                                </form>
                            </div>
                        </details>

                        <!-- SECTION 3: FOOTER -->
                        <details class="sub-accordion">
                            <summary
                                class="font-serif font-weight-600 cursor-pointer p-10 bg-gray-light border-radius-4">
                                3. Rodapé
                            </summary>
                            <div class="p-10 mt-10">
                                <form id="footer-form" class="auth-form">
                                    <!-- Footer Inputs -->
                                    <div class="form-group">
                                        <label>Título / Logótipo do Rodapé</label>
                                        <input type="text" id="footer-title-input" placeholder="Ex: Floresce Terapias">
                                    </div>
                                    <div class="form-group">
                                        <label>Direitos Reservados</label>
                                        <input type="text" id="footer-copyright-input" placeholder="Ex: &copy; 2026...">
                                    </div>
                                    <div class="form-group">
                                        <label>Créditos</label>
                                        <input type="text" id="footer-dev-input" placeholder="Ex: CREATED BY...">
                                    </div>
                                    <div class="form-group grid-2-col-gap-20">
                                        <div>
                                            <label>Fundo do Rodapé</label>
                                            <div class="flex-align-center-gap-10">
                                                <input type="color" id="footer-bg-color" value="#80864f"
                                                    class="color-preview-box">
                                                <input type="text" id="footer-bg-hex" value="#80864f" maxlength="7"
                                                    class="color-text-input">
                                            </div>
                                        </div>
                                        <div>
                                            <label>Texto do Rodapé</label>
                                            <div class="flex-align-center-gap-10">
                                                <input type="color" id="footer-text-color" value="#ffffff"
                                                    class="color-preview-box">
                                                <input type="text" id="footer-text-hex" value="#ffffff" maxlength="7"
                                                    class="color-text-input">
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="cta-button primary full-width mt-10">Guardar
                                        Rodapé</button>
                                </form>
                            </div>
                        </details>
                    </div>
                </details>
            </div> <!-- End of dashboard-cards-container -->
        </section>

        <!-- Carousel Section -->
        <section class="content-section">
            <h2 class="section-title text-center-primary"></h2>

            <!-- Carousel Container (Themes / Meditations View) -->
            <div class="carousel-wrapper relative">
                <button class="carousel-nav prev" id="themes-prev-btn" aria-label="Anterior"><i
                        data-lucide="chevron-left"></i></button>

                <div class="carousel-container" id="themes-carousel-container">
                    <!-- Dynamic Content Loads Here -->
                    <div class="carousel-loader carousel-loader-content">
                        <i data-lucide="loader-2" class="animate-spin text-white mb-2"></i>
                        <p class="text-white">A carregar...</p>
                    </div>
                </div>

                <button class="carousel-nav next" id="themes-next-btn" aria-label="Seguinte"><i
                        data-lucide="chevron-right"></i></button>
            </div>
        </section>
    </main>

    <script src="carousel.js"></script>
    <script src="sidebar.js"></script>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // Handle Mobile Logout
        const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
        if (mobileLogoutBtn) {
            mobileLogoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const mainLogoutBtn = document.getElementById('logout-btn');
                if (mainLogoutBtn) mainLogoutBtn.click();
            });
        }

        // Sync User Name for Mobile Menu
        const nameDisplay = document.getElementById('user-name-display');
        const mobileNameDisplay = document.getElementById('mobile-user-name');

        // Load Saved Name
        const savedName = localStorage.getItem('userName');
        if (savedName && nameDisplay) {
            nameDisplay.textContent = savedName;
        }

        // Observer to copy name when it changes (populated by Firebase)
        const observer = new MutationObserver(() => {
            if (mobileNameDisplay) mobileNameDisplay.textContent = nameDisplay.textContent;
        });
        if (nameDisplay) {
            // Initial sync
            if (mobileNameDisplay) mobileNameDisplay.textContent = nameDisplay.textContent;
            observer.observe(nameDisplay, { childList: true, characterData: true, subtree: true });
        }
        // UNIFIED DASHBOARD CAROUSEL ENGINE



        // --- RESOURCE GROUPING LOGIC ---

        // 1. Grid View Element (Injected dynamically or we can add to DOM)
        // Let's create the Grid Container programmatically or find a place for it.
        // We'll insert it right after the carousel wrapper.
        const carouselSection = document.querySelector('.carousel-wrapper');

        const gridContainer = document.createElement('div');
        gridContainer.id = 'meditations-grid-view';
        gridContainer.className = 'hidden';
        gridContainer.innerHTML = `
                <div class="mb-20">
                    <button class="cta-button outline small" onclick="closeGroupView()" style="display:flex; align-items:center; gap:8px;">
                        <i data-lucide="arrow-left" style="width:16px; height:16px;"></i> Voltar
                    </button>
                    <!-- Title removed as requested (redundant) -->
                </div>
                <div id="meditations-grid-content" class="meditations-grid-layout">
                    <!-- Grid Items Injected Here -->
                </div>
            `;
        if (carouselSection) {
            carouselSection.parentNode.insertBefore(gridContainer, carouselSection.nextSibling);
        }

        // Global State for Meditations
        let allMeditations = [];
        let groupedMeditations = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAndGroupMeditations();
        });

        async function loadAndGroupMeditations() {
            const loader = document.querySelector('.carousel-loader-content');

            try {
                // Wait for DB
                let retries = 0;
                while (!window.db && retries < 20) {
                    await new Promise(r => setTimeout(r, 200));
                    retries++;
                }

                if (!window.db) {
                    console.error("DB not found");
                    if (loader) loader.innerHTML = '<p class="text-red">Erro de conexão.</p>';
                    return;
                }

                // Fetch All meditations (filtering active in memory if needed or just sorting)
                const snapshot = await window.db.collection('meditations')
                    .orderBy('created_at', 'desc')
                    .get();

                if (snapshot.empty) {
                    if (loader) loader.innerHTML = '<p>Sem conteúdos disponíveis.</p>';
                    return;
                }

                // Process Data
                allMeditations = [];
                groupedMeditations = {};

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const item = { id: doc.id, ...data };
                    allMeditations.push(item);

                    // Group by Title (Theme Name)
                    // Use 'card_title' as the grouping key as requested
                    const groupName = item.card_title || 'Outros';

                    if (!groupedMeditations[groupName]) {
                        groupedMeditations[groupName] = {
                            title: groupName,
                            items: [],
                            // Use the image/color of the first item as the group representative
                            image_url: item.image_url,
                            card_bg_type: item.card_bg_type,
                            card_bg_color: item.card_bg_color,
                            card_opacity: item.card_opacity,
                            theme: item.theme
                        };
                    }
                    groupedMeditations[groupName].items.push(item);
                });

                // Convert to Array for Carousel
                const groupArray = Object.values(groupedMeditations);

                // clear loader
                const container = document.getElementById('themes-carousel-container');
                if (container) container.innerHTML = '';

                // Instantiate Carousel with GROUP Data
                new DashboardCarousel({
                    containerId: 'themes-carousel-container',
                    prevBtnId: 'themes-prev-btn',
                    nextBtnId: 'themes-next-btn',
                    data: groupArray, // Pass pre-processed groups
                    enableLoop: false, // User requested static view for few items
                    renderCard: (group) => {
                        // Custom Card Renderer for Groups
                        const count = group.items.length;
                        const resourceLabel = count === 1 ? 'recurso' : 'recursos';

                        // Style Logic (Reused from generic, but applied to Group)
                        let bgStyle;
                        if (group.card_bg_type === 'color') {
                            bgStyle = `background-color: ${group.card_bg_color || '#80864f'};`;
                        } else {
                            const img = group.image_url || 'https://images.unsplash.com/photo-1518241353330-0f7941c2d9b5?auto=format&fit=crop&w=400&q=80';
                            bgStyle = `background-image: url('${img}'); background-size: cover; background-position: center;`;
                        }

                        let opVal = (group.card_opacity !== undefined && group.card_opacity !== null) ? group.card_opacity : 0.3;
                        if (typeof opVal === 'string') opVal = opVal.replace(',', '.');
                        const overlayStyle = `background-color: rgba(0,0,0, ${opVal}); position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; border-radius: 12px 12px 0 0;`;

                        // Icon mapping
                        let iconName = 'folder-open'; // Default for group
                        if (group.theme === 'enraizamento') iconName = 'anchor';
                        if (group.theme === 'limpeza') iconName = 'droplets';
                        if (group.theme === 'protecao') iconName = 'shield';
                        if (group.theme === 'intuicao') iconName = 'eye';
                        if (group.theme === 'chakras') iconName = 'aperture';

                        // OnClick: Call openGroupView with the group title (key)
                        // We use .replace for quotes to avoid syntax errors in string injection
                        const safeTitle = group.title.replace(/'/g, "\\'");

                        // Card Text Logic
                        let cardText = "Explorar coleção...";
                        try {
                            const savedTheme = JSON.parse(localStorage.getItem('site_theme')) || {};

                            // Check for specific text for this theme (group.title is the key)
                            if (savedTheme.card_texts && savedTheme.card_texts[group.title]) {
                                cardText = savedTheme.card_texts[group.title];
                            }
                            // Fallback to global if specific not set (or empty? let's prioritize specific even if empty string? No, if distinct key exists)
                            else if (savedTheme.card_text && savedTheme.card_text.trim() !== "") {
                                cardText = savedTheme.card_text;
                            }
                        } catch (e) { }

                        // CLEANED UI: No Icon or Text Overlay in Image
                        return `
                                <div class="carousel-card cursor-pointer" onclick="openGroupView('${safeTitle}')">
                                    <div class="carousel-image relative" style="${bgStyle}">
                                        <div style="${overlayStyle}"></div>
                                        <!-- Removed Icon and Text Overlay as requested -->
                                    </div>
                                    <div class="carousel-content">
                                        <h3>${group.title}</h3>
                                        <p class="font-xs text-muted">${cardText}</p>
                                    </div>
                                </div>
                            `;
                    }
                });
                if (window.lucide) lucide.createIcons();

            } catch (e) {
                console.error("Error grouping meditations:", e);
                if (loader) loader.innerHTML = '<p class="text-red">Erro ao carregar recursos.</p>';
            }
        }

        // Window functions for interactivity
        window.openGroupView = (groupTitle) => {
            const group = groupedMeditations[groupTitle];
            if (!group) return;

            // 1. Switch Views
            document.querySelector('.carousel-wrapper').classList.add('hidden');
            document.getElementById('meditations-grid-view').classList.remove('hidden');

            // 2. Set Title (Element removed, skipping)
            // document.getElementById('grid-view-title').innerText = group.title;
            // Also update main dashboard title as requested
            const mainTitle = document.getElementById('main-dashboard-title');
            if (mainTitle) mainTitle.innerText = group.title;

            // 3. Render Grid Items
            const gridContent = document.getElementById('meditations-grid-content');
            let html = '';

            group.items.forEach(item => {
                // Item Card Logic (300x300 style)
                // We can reuse similar styling or make a more detailed card

                let bgStyle;
                if (item.card_bg_type === 'color') {
                    bgStyle = `background-color: ${item.card_bg_color || '#80864f'};`;
                } else {
                    const img = item.image_url || 'https://images.unsplash.com/photo-1518241353330-0f7941c2d9b5?auto=format&fit=crop&w=400&q=80';
                    bgStyle = `background-image: url('${img}'); background-size: cover; background-position: center;`;
                }

                let opVal = (item.card_opacity !== undefined) ? item.card_opacity : 0.3;
                const overlayStyle = `background-color: rgba(0,0,0, ${opVal}); position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; border-radius: 8px;`;

                // Icon
                let iconName = 'headphones';
                if (item.type === 'video') iconName = 'video';
                if (item.type === 'pdf') iconName = 'file-text';

                html += `
                    <div class="meditation-grid-card">
                        <a href="theme?id=${item.id}" class="block full-height text-decoration-none">
                            <div class="grid-card-image relative" style="${bgStyle}">
                                <div style="${overlayStyle}"></div>
                                <i data-lucide="${iconName}" size="24" color="#ffffff" style="position:relative; z-index:2;"></i>
                            </div>
                            <div class="grid-card-content">
                                <h4 class="font-serif margin-0 truncate-2-lines">${item.title}</h4>
                                <p class="font-xs text-muted margin-0 mt-5">${item.type ? item.type.toUpperCase() : 'ÁUDIO'}</p>
                            </div>
                        </a>
                    </div>
                    `;
            });

            gridContent.innerHTML = html;
            if (window.lucide) lucide.createIcons();
        };

        window.closeGroupView = () => {
            document.querySelector('.carousel-wrapper').classList.remove('hidden');
            document.getElementById('meditations-grid-view').classList.add('hidden');
            // Revert main title
            const mainTitle = document.getElementById('main-dashboard-title');
            if (mainTitle) mainTitle.innerText = 'As Minhas Meditações';
        };

    </script>

    <!-- AUTO-LOAD MEMBERS PANEL ON OPEN -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const membersCard = document.getElementById('card-members');
            if (membersCard) {
                membersCard.addEventListener('toggle', () => {
                    if (membersCard.open && window.loadMembers) {
                        window.loadMembers();
                    }
                });
            }
        });
    </script>

    <!-- DRAG AND DROP LOGIC FOR DASHBOARD CARDS -->
    <!-- Sortable and CMS ordering initialized in cms.js -->




    <!-- Custom Scripts -->
    <script>
        // Initialize CMS
        if (window.initCMS) {
            window.initCMS();
        }

        // Tab Switching Logic (Global) - Legacy support if needed, but we use Accordions now
        window.openSection = function (sectionId) {
            // With accordion, we might want to just open the relevant detail
            // For now, this old function can just return or log

        }
    </script>

    <script>
        // Protect Route & Auth Logic
        // Protect Route & Auth Logic
        const localUser = localStorage.getItem('userEmail');

        // Helper: Check Status
        // Helper: Check Status and Show Modal if needed
        async function verifyUserStatus(email) {
            if (!window.db) return true;
            try {
                const docSnap = await window.db.collection("users").doc(email).get();
                if (docSnap.exists) {
                    const data = docSnap.data();

                    // If user is BLOCKED, SHOW MODAL
                    // 'pending' is now considered active for free access
                    if (data.status === 'blocked') {


                        // Show Modal
                        const modal = document.getElementById('subscriptionModal');
                        if (modal) {
                            modal.classList.remove('hidden');
                            modal.classList.add('flex'); // Ensure flex is added specifically
                        }

                        // Freeze background scrolling
                        document.body.style.overflow = 'hidden';
                        return false; // Stop further loading
                    }
                }
            } catch (error) {
                console.error("Status check failed", error);
            }
            return true;
        }

        async function logoutAndRedirect() {
            if (window.auth) await auth.signOut();
            localStorage.clear();
            window.location.href = 'login.html';
        }

        // Modal Actions
        function logoutFromModal() {
            logoutAndRedirect();
        }

        // Modal Actions
        function logoutFromModal() {
            logoutAndRedirect();
        }

        // startSubscription is now global in script.js
        // resetBtn is now global in script.js

        if (!localUser) {
            if (window.auth) {
                auth.onAuthStateChanged(async (user) => {
                    if (!user) {
                        window.location.href = 'login.html';
                    } else {
                        // Check Status
                        try {
                            if (window.verifyUserStatus) {
                                await window.verifyUserStatus(user.email);
                            } else {
                                console.warn("verifyUserStatus not found in window! Retrying in 1s...");
                                setTimeout(() => {
                                    if (window.verifyUserStatus) window.verifyUserStatus(user.email);
                                }, 1000);
                            }
                        } catch (e) {
                            console.error("verify logic error", e);
                        }

                        localStorage.setItem('userEmail', user.email);
                        localStorage.setItem('isMember', 'true');

                        let finalName = user.displayName;
                        if (!finalName) {
                            try {
                                const userDocRef = window.db.collection("users").doc(user.email);
                                const userDocSnap = await userDocRef.get();
                                if (userDocSnap.exists) finalName = userDocSnap.data().name;
                            } catch (e) { }
                        }
                        if (!finalName) finalName = user.email.split('@')[0];

                        localStorage.setItem('userName', finalName);

                        // Update UI Immediately
                        const nameDisplay = document.getElementById('header-welcome-msg');
                        if (nameDisplay) nameDisplay.textContent = `Olá, ${finalName}`;
                        updateUserDisplay(finalName);

                        // Fix for missing sidebar button (Manual Injection)
                        ensureMobileLogoutButton();
                    }
                });
            } else {
                window.location.href = 'login.html';
            }
        } else {
            // Already logged in locally, but verify status in background
            if (window.auth) {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        if (user.email !== localUser) {
                            localStorage.setItem('userEmail', user.email);
                        }

                        // Check Admin for Central Button
                        const isAdmin = localStorage.getItem('isAdmin') === 'true';
                        const adminBtn = document.getElementById('admin-toggle-btn');
                        const adminPanel = document.getElementById('admin-panel');

                        if (isAdmin && adminBtn) {
                            adminBtn.style.display = 'inline-flex'; // Show button

                            // Add Click Listener
                            adminBtn.onclick = () => {
                                if (adminPanel) {
                                    adminPanel.style.display = 'block'; // Ensure it's not hidden
                                    adminPanel.scrollIntoView({ behavior: 'smooth' });
                                }
                            };
                        }

                        // Verify Status Background Check
                        try {
                            if (window.verifyUserStatus) {
                                await window.verifyUserStatus(user.email);
                            }
                        } catch (e) { console.error(e); }
                    } else {
                        // Session expired
                        await logoutAndRedirect();
                    }
                });
            }
            updateUserDisplay(localStorage.getItem('userName') || 'Visitante');
        }

        function updateUserDisplay(name) {
            const nameDisplay = document.getElementById('user-name-display');
            const mobileNameDisplay = document.getElementById('mobile-user-name');
            const welcomeDisplay = document.getElementById('header-welcome-msg');

            if (nameDisplay) nameDisplay.textContent = name;
            if (mobileNameDisplay) mobileNameDisplay.textContent = name;
            if (welcomeDisplay) {
                welcomeDisplay.textContent = `Olá, ${name}`;
                welcomeDisplay.style.display = 'inline-block';
            }

            ensureMobileLogoutButton();
        }

        function ensureMobileLogoutButton() {
            // Fix for missing sidebar button (Manual Injection)
            if (window.updateMobileAuthUI) {
                window.updateMobileAuthUI();
            } else {
                // Fallback if script.js isn't ready
                const mobileMenu = document.querySelector('.mobile-menu');
                const socials = document.querySelector('.mobile-socials');
                if (mobileMenu && socials && !document.getElementById('mobile-logout-btn')) {

                    const btn = document.createElement('a');
                    btn.href = '#';
                    btn.id = 'mobile-logout-btn';
                    // Ensure high contrast and display block
                    btn.style.cssText = 'color: #e57373 !important; display: flex !important; align-items: center; gap: 8px; font-weight: 500; padding: 10px 0; margin-top: 10px; cursor: pointer;';
                    btn.innerHTML = '<i data-lucide="log-out" style="width: 18px;"></i> Sair da Conta';
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (confirm('Tem a certeza que deseja sair?')) {
                            localStorage.clear();
                            window.location.href = 'index.html';
                        }
                    });

                    // Insert BEFORE the socials div wrapper, not inside it or mixed weirdly
                    // This ensures it sits above the social icons
                    const divider = document.createElement('div');
                    divider.style.cssText = 'height: 1px; background: #eee; margin: 15px 0;';

                    socials.parentNode.insertBefore(divider, socials);
                    socials.parentNode.insertBefore(btn, socials);

                    if (window.lucide) window.lucide.createIcons();
                }
            }
        }

        // Logout
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (window.auth) auth.signOut();
                localStorage.clear();
                window.location.href = 'index.html';
            });
        }

    </script>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <p class="logo-text" id="footer-title"></p>
                <div class="footer-links">
                    <a href="termos.html">Termos e Privacidade</a>
                </div>
                <p class="copyright" id="footer-copyright"></p>
                <p class="developer-credit" id="footer-credit"></p>
            </div>
        </div>
    </footer>

    <script src="sidebar.js"></script>
</body>

</html>